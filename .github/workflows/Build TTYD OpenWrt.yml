name: "OpenWrt SDK Build - B"

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: "SSH into Actions"
        required: false
        default: "false"

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/jarod360/openwrt_ttyd

jobs:
  build:
    name: Build (${ { matrix.platform } })
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/ath79/generic/openwrt-sdk-24.10.4-ath79-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst

          # Snapshots
          - platform: x86_64_snapshot
            url_sdk: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
          - platform: aarch64_generic_snapshot
            url_sdk: https://downloads.openwrt.org/snapshots/targets/rockchip/armv8/openwrt-sdk-rockchip-armv8_gcc-14.3.0_musl.Linux-x86_64.tar.zst

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison \
            build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler \
            fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev \
            gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev \
            libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev \
            lld llvm lrzsz mkisofs msmtp ninja-build p7zip-full patch pkgconf python3 \
            python3-pip python3-docutils python3-ply python3-pyelftools qemu-utils \
            re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            unzip vim wget xmlto xxd zlib1g-dev zstd

      - name: Download SDK
        run: |
          wget ${{ matrix.url_sdk }}
          FILE=$(basename ${{ matrix.url_sdk }})
          mkdir sdk
          if [[ $FILE == *.tar.xz ]]; then
            tar -xJf $FILE -C sdk --strip-components=1
          else
            tar --zstd -xf $FILE -C sdk --strip-components=1
          fi

      - name: Prepare Feeds
        run: |
          cd sdk
          sed -i \
            -e 's|git.openwrt.org/feed|github.com/openwrt|g' \
            -e 's|git.openwrt.org/project|github.com/openwrt|g' \
            -e 's|git.openwrt.org/openwrt|github.com/openwrt|g' \
            feeds.conf.default

          echo "src-git myrepo ${{ env.REPO_URL }};main" >> feeds.conf.default

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: SSH to Actions
        uses: mxschmitt/action-tmate@v3
        if: github.event.inputs.ssh == 'true'

      - name: Configure Build
        run: |
          cd sdk
          echo "CONFIG_ALL=n" > .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=m" >> .config
          echo "CONFIG_PACKAGE_ttyd=m" >> .config
          make defconfig

      - name: Build Package
        run: |
          cd sdk
          make package/ttyd/{clean,compile} -j$(nproc) V=s || true
          make package/luci-app-ttyd/{clean,compile} -j$(nproc) V=s || true

      - name: Collect Artifacts
        run: |
          cd sdk
          mkdir -p upload
          find bin/packages -name "*.ipk" -exec cp {} upload/ \;

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "build-${{ github.run_id }}"
          files: sdk/upload/*.ipk
