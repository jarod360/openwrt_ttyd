#
# Copyright (c) 2022-2025 SMALLPROGRAM <https://github.com/smallprogram>
# Description: Auto compile ttyd with openwrt sdk
#
name: "Auto compile ttyd with openwrt sdk"

# ä¿®å¤æƒé™é—®é¢˜
permissions:
  contents: write

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè¿æ¥ Actions'
        required: false
        default: 'false'
env:
  TZ: Asia/Shanghai
  repo: ${{ github.repository }}
  package_names: "libwebsockets-full ttyd luci-app-ttyd"

jobs:
  job_auto_compile:
    runs-on: ubuntu-latest
    name: build ttyd (${{ matrix.ver }}-${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # ç¨³å®šç‰ˆ (ipk) å¹³å°
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa53/openwrt-sdk-24.10.4-mvebu-cortexa53_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa72/openwrt-sdk-24.10.4-mvebu-cortexa72_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/sunxi/cortexa7/openwrt-sdk-24.10.4-sunxi-cortexa7_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/ath79/generic/openwrt-sdk-24.10.4-ath79-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/ramips/rt288x/openwrt-sdk-24.10.4-ramips-rt288x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          # å¼€å‘ç‰ˆ (apk) å¹³å°
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/snapshots/targets/rockchip/armv8/openwrt-sdk-rockchip-armv8_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa53/openwrt-sdk-mvebu-cortexa53_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa72/openwrt-sdk-mvebu-cortexa72_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa7/openwrt-sdk-sunxi-cortexa7_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ath79/generic/openwrt-sdk-ath79-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ramips/rt288x/openwrt-sdk-ramips-rt288x_gcc-14.2.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

    steps:
      - name: åˆå§‹åŒ– ${{ matrix.platform }} ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          echo "å®‰è£…ç¼–è¯‘ä¾èµ–åŒ…"
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: ä¸‹è½½ ${{ matrix.platform }} SDK
        run: |
          wget ${{ matrix.url_sdk }}
          file_name=$(echo ${{matrix.url_sdk}} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_name"
            exit 1
          fi
          cd sdk

      - name: SSH è¿æ¥åˆ° Actions
        uses: mxschmitt/action-tmate@v3.13
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

      - name: é…ç½® ${{ matrix.platform }} feeds å¹¶å½»åº•åˆ é™¤ SDK åŒ…
        run: |
          cd sdk
          
          echo "=== å¼€å§‹å½»åº•åˆ é™¤ SDK ä¸­çš„ç›¸å…³åŒ… ==="
          
          # ä½¿ç”¨ find å‘½ä»¤æœç´¢æ‰€æœ‰ç›¸å…³åŒ…çš„ä½ç½®
          echo "æœç´¢ ttyd ç›¸å…³æ–‡ä»¶..."
          find . -type d -name "*ttyd*" | head -20
          
          echo "æœç´¢ libwebsockets ç›¸å…³æ–‡ä»¶..."
          find . -type d -name "*libwebsockets*" | head -20
          
          # å½»åº•åˆ é™¤æ‰€æœ‰å¯èƒ½ä½ç½®çš„åŒ…
          echo "å¼€å§‹åˆ é™¤åŒ…..."
          for dir in \
            "package/feeds/packages/ttyd" \
            "package/feeds/packages/libwebsockets" \
            "package/feeds/luci/luci-app-ttyd" \
            "package/feeds/base/ttyd" \
            "package/feeds/base/libwebsockets" \
            "package/feeds/base/luci-app-ttyd" \
            "package/network/services/ttyd" \
            "package/network/services/libwebsockets" \
            "feeds/packages/utils/ttyd" \
            "feeds/packages/libs/libwebsockets" \
            "feeds/luci/applications/luci-app-ttyd" \
            "feeds/base/ttyd" \
            "feeds/base/libwebsockets" \
            "feeds/base/luci-app-ttyd"; do
            if [ -d "$dir" ]; then
              echo "åˆ é™¤ç›®å½•: $dir"
              rm -rf "$dir"
            fi
          done
          
          # å†æ¬¡æœç´¢ç¡®è®¤åˆ é™¤ç»“æœ
          echo "=== ç¡®è®¤åˆ é™¤ç»“æœ ==="
          echo "å‰©ä½™ ttyd ç›¸å…³ç›®å½•:"
          find . -type d -name "*ttyd*" | head -10
          echo "å‰©ä½™ libwebsockets ç›¸å…³ç›®å½•:"
          find . -type d -name "*libwebsockets*" | head -10
          
          # æ›´æ–° feeds åˆ° github æº
          sed -i \
              -e 's|git\.openwrt\.org/feed|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/project|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/openwrt|github.com/openwrt|g' \
              "feeds.conf.default"

          # æ·»åŠ æˆ‘ä»¬çš„ä»“åº“åˆ° feeds
          cat > feeds.tmp <<'EOF'
          src-git custom_packages https://github.com/${{ env.repo }}.git;${{ github.ref_name }}
          EOF
          cat feeds.conf.default >> feeds.tmp
          mv feeds.tmp feeds.conf.default

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # å†æ¬¡æ£€æŸ¥å¹¶åˆ é™¤å¯èƒ½é€šè¿‡ feeds é‡æ–°å®‰è£…çš„åŒ…
          echo "=== å†æ¬¡æ£€æŸ¥å¹¶åˆ é™¤ feeds å®‰è£…çš„åŒ… ==="
          for dir in \
            "package/feeds/packages/ttyd" \
            "package/feeds/packages/libwebsockets" \
            "package/feeds/luci/luci-app-ttyd"; do
            if [ -d "$dir" ]; then
              echo "åˆ é™¤ feeds ç›®å½•: $dir"
              rm -rf "$dir"
            fi
          done

          # éªŒè¯æˆ‘ä»¬çš„åŒ…æ˜¯å¦å­˜åœ¨
          echo "=== éªŒè¯æˆ‘ä»¬çš„åŒ… ==="
          if [ -d "feeds/custom_packages/package/ttyd" ]; then
            echo "âœ“ æ‰¾åˆ°æˆ‘ä»¬çš„ ttyd åŒ…"
          else
            echo "âœ— æœªæ‰¾åˆ°æˆ‘ä»¬çš„ ttyd åŒ…"
            exit 1
          fi
          
          if [ -d "feeds/custom_packages/package/luci-app-ttyd" ]; then
            echo "âœ“ æ‰¾åˆ°æˆ‘ä»¬çš„ luci-app-ttyd åŒ…"
          else
            echo "âœ— æœªæ‰¾åˆ°æˆ‘ä»¬çš„ luci-app-ttyd åŒ…"
            exit 1
          fi
          
          if [ -d "feeds/custom_packages/package/libwebsockets-full" ]; then
            echo "âœ“ æ‰¾åˆ°æˆ‘ä»¬çš„ libwebsockets-full åŒ…"
          else
            echo "âœ— æœªæ‰¾åˆ°æˆ‘ä»¬çš„ libwebsockets-full åŒ…"
            exit 1
          fi

          # æ›´æ–°å¿…è¦çš„ç»„ä»¶
          rm -rf temp_resp
          git clone -b master --single-branch https://github.com/openwrt/packages.git temp_resp
          echo "æ›´æ–° golang ç‰ˆæœ¬"
          rm -rf feeds/packages/lang/golang
          cp -r temp_resp/lang/golang feeds/packages/lang
          rm -rf temp_resp

          git clone -b main --single-branch https://github.com/openwrt/openwrt.git temp_resp
          cp -f temp_resp/scripts/patch-kernel.sh scripts/
          rm -rf temp_resp

          # é…ç½®ç¼–è¯‘é€‰é¡¹
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=m" >> .config
          echo "CONFIG_PACKAGE_ttyd=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=m" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

          make defconfig

      - name: ${{ matrix.platform }} ç¼–è¯‘ ttyd åŒ…
        id: compile
        run: |
          cd sdk
          echo "=== å¼€å§‹ç¼–è¯‘ ttyd ç›¸å…³åŒ… ==="
          
          # éªŒè¯å½“å‰ç¼–è¯‘çš„æ˜¯æˆ‘ä»¬çš„åŒ…
          echo "=== éªŒè¯ç¼–è¯‘æº ==="
          echo "libwebsockets-full è·¯å¾„:"
          find . -path "*/libwebsockets-full/Makefile" | grep -v "feeds/custom_packages" || echo "âœ“ åªæœ‰æˆ‘ä»¬çš„ libwebsockets-full"
          echo "ttyd è·¯å¾„:"
          find . -path "*/ttyd/Makefile" | grep -v "feeds/custom_packages" || echo "âœ“ åªæœ‰æˆ‘ä»¬çš„ ttyd"
          echo "luci-app-ttyd è·¯å¾„:"
          find . -path "*/luci-app-ttyd/Makefile" | grep -v "feeds/custom_packages" || echo "âœ“ åªæœ‰æˆ‘ä»¬çš„ luci-app-ttyd"
          
          # ç¼–è¯‘ libwebsockets-full (ä¾èµ–)
          if [ -d "feeds/custom_packages/package/libwebsockets-full" ]; then
              echo "----------- å¼€å§‹ç¼–è¯‘ libwebsockets-full ---------------"
              make package/feeds/custom_packages/libwebsockets-full/compile -j$(nproc) V=sc
              echo "âœ“ libwebsockets-full ç¼–è¯‘å®Œæˆ"
              echo ""
          else
              echo "âœ— é”™è¯¯: åœ¨ custom_packages ä¸­æœªæ‰¾åˆ° libwebsockets-full"
              exit 1
          fi

          # ç¼–è¯‘ ttyd
          if [ -d "feeds/custom_packages/package/ttyd" ]; then
              echo "----------- å¼€å§‹ç¼–è¯‘ ttyd ---------------"
              make package/feeds/custom_packages/ttyd/compile -j$(nproc) V=sc
              echo "âœ“ ttyd ç¼–è¯‘å®Œæˆ"
              echo ""
          else
              echo "âœ— é”™è¯¯: åœ¨ custom_packages ä¸­æœªæ‰¾åˆ° ttyd"
              exit 1
          fi

          # ç¼–è¯‘ luci-app-ttyd
          if [ -d "feeds/custom_packages/package/luci-app-ttyd" ]; then
              echo "----------- å¼€å§‹ç¼–è¯‘ luci-app-ttyd ---------------"
              make package/feeds/custom_packages/luci-app-ttyd/compile -j$(nproc) V=sc
              echo "âœ“ luci-app-ttyd ç¼–è¯‘å®Œæˆ"
              echo ""
          else
              echo "âœ— é”™è¯¯: åœ¨ custom_packages ä¸­æœªæ‰¾åˆ° luci-app-ttyd"
              exit 1
          fi

          echo "=== æ‰€æœ‰åŒ…ç¼–è¯‘æˆåŠŸ ==="
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ•´ç† ${{ matrix.platform }} æ–‡ä»¶
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk

          mkdir -p tmp_upload
          shopt -s nullglob 
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶æ‰€æœ‰ç¼–è¯‘çš„åŒ…
          for src_dir in bin/packages/*/{packages,custom_packages,luci}; do
              [[ -d "$src_dir" ]] || continue

              echo "æ‰«æç›®å½•: $src_dir"

              for prefix in libwebsockets ttyd luci-app-ttyd; do
                  for file in "$src_dir"/"$prefix"*; do
                      [[ -f "$file" ]] || continue

                      filename=$(basename "$file")
                      echo "  æ‰¾åˆ°æ–‡ä»¶: $filename"
                      cp -r "$file" "tmp_upload/"
                  done
              done
          done

          # åˆ›å»ºä¸Šä¼ ç›®å½•å¹¶æ‰“åŒ…æ–‡ä»¶
          mkdir -p upload
          if [ "$(ls -A tmp_upload/)" ]; then
              zip -jr upload/ttyd_packages_${{ matrix.ver }}_${{ matrix.platform }}.zip tmp_upload/*
              echo "æ–‡ä»¶æ‰“åŒ…æˆåŠŸ"
              echo "æ‰“åŒ…çš„æ–‡ä»¶:"
              ls -la tmp_upload/
          else
              echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶è¿›è¡Œæ‰“åŒ…"
              find bin/packages -name "*ttyd*" -o -name "*libwebsockets*" | head -20
              exit 1
          fi

          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk
          echo "## ğŸš€ ttyd è½¯ä»¶åŒ…ç¼–è¯‘æŠ¥å‘Š" >> release.txt
          echo "### ç¼–è¯‘ä¿¡æ¯" >> release.txt
          echo "**å¹³å°**: ${{ matrix.platform }}" >> release.txt
          echo "**ç‰ˆæœ¬ç±»å‹**: ${{ matrix.ver }}" >> release.txt
          echo "**ç¼–è¯‘æ—¥æœŸ**: $(date)" >> release.txt

          echo "### ç¼–è¯‘çš„è½¯ä»¶åŒ…" >> release.txt
          echo "**åŒ…å**|**ç‰ˆæœ¬**" >> release.txt
          echo "-|-" >> release.txt

          # ä» Makefiles æå–ç‰ˆæœ¬ä¿¡æ¯
          if [ -f "feeds/custom_packages/package/libwebsockets-full/Makefile" ]; then
              version=$(awk -F ':=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' feeds/custom_packages/package/libwebsockets-full/Makefile | tr -d ' ')
              echo "**libwebsockets-full**|**$version**" >> release.txt
          fi

          if [ -f "feeds/custom_packages/package/ttyd/Makefile" ]; then
              version=$(awk -F ':=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' feeds/custom_packages/package/ttyd/Makefile | tr -d ' ')
              echo "**ttyd**|**$version**" >> release.txt
          fi

          if [ -f "feeds/custom_packages/package/luci-app-ttyd/Makefile" ]; then
              version=$(awk -F ':=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' feeds/custom_packages/package/luci-app-ttyd/Makefile | tr -d ' ')
              echo "**luci-app-ttyd**|**$version**" >> release.txt
          fi

          echo "### æ–‡ä»¶åˆ—è¡¨" >> release.txt
          echo "\`\`\`" >> release.txt
          ls -la tmp_upload/ >> release.txt
          echo "\`\`\`" >> release.txt

          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ åˆ¶å“
        uses: actions/upload-artifact@v4
        if: steps.info.outputs.status == 'success'
        with:
          name: ttyd_${{ matrix.ver }}_${{ matrix.platform }}
          path: ${{ env.FIRMWARE }}/upload/*
          retention-days: 30

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.info.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # ä¿®å¤æ ‡ç­¾åé—®é¢˜ - ä½¿ç”¨é™æ€æ ‡ç­¾å
          tag_name: ttyd-packages-${{ matrix.ver }}-${{ matrix.platform }}
          name: "TTYD Packages ${{ matrix.ver }} - ${{ matrix.platform }}"
          body_path: ${{ env.FIRMWARE }}/release.txt
          files: ${{ env.FIRMWARE }}/upload/ttyd_packages_${{ matrix.ver }}_${{ matrix.platform }}.zip
          draft: false
          prerelease: false
          # å¦‚æœæ ‡ç­¾å·²å­˜åœ¨åˆ™æ›´æ–°
          replace_existing: true
