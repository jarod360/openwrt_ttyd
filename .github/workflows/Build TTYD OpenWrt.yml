name: Build OpenWrt Packages

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev

      - name: 创建并进入 SDK 目录
        run: |
          mkdir -p sdk
          cd sdk

      - name: 下载 OpenWrt SDK
        run: |
          cd sdk
          wget https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz
          tar xf openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz
          mv openwrt-sdk-* sdkroot

      - name: 准备 SDK 构建环境
        run: |
          cd sdk/sdkroot
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 删除 SDK 自带的包，确保只使用你的 package 目录
          rm -rf package/feeds/packages/ttyd
          rm -rf package/feeds/packages/libwebsockets
          rm -rf package/feeds/packages/libwebsockets-full
          rm -rf package/feeds/luci/luci-app-ttyd
          rm -rf package/libs/libwebsockets

          # 复制你仓库中的 package
          cp -rf $GITHUB_WORKSPACE/package/* package/

      - name: 配置 .config（指定 OpenSSL 1.1.1）
        run: |
          cd sdk/sdkroot
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_PACKAGE_openssl=m" >> .config
          echo "CONFIG_PACKAGE_openssl3=n" >> .config
          echo "CONFIG_PACKAGE_libuv=m" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=m" >> .config
          echo "CONFIG_PACKAGE_ttyd=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-ttyd-zh-cn=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=m" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

          make defconfig

      - name: 编译 OpenSSL（1.1.1）
        run: |
          cd sdk/sdkroot
          make package/libs/openssl/compile V=sc -j$(nproc)

      - name: 编译全部目标包（ttyd / websockets / luci）
        run: |
          cd sdk/sdkroot
          make package/libuv/compile V=sc -j$(nproc)
          make package/libwebsockets-full/compile V=sc -j$(nproc)
          make package/ttyd/compile V=sc -j$(nproc)
          make package/luci-app-ttyd/compile V=sc -j$(nproc)
          make package/luci-app-diskman/compile V=sc -j$(nproc)

      - name: 收集编译产物
        run: |
          mkdir -p output
          cd sdk/sdkroot

          echo "收集 openssl..."
          cp bin/packages/*/*/openssl*.ipk $GITHUB_WORKSPACE/output/ 2>/dev/null || true

          echo "收集 libwebsockets-full..."
          cp bin/packages/*/*/libwebsockets*.ipk $GITHUB_WORKSPACE/output/ 2>/dev/null || true

          echo "收集 ttyd..."
          cp bin/packages/*/*/ttyd*.ipk $GITHUB_WORKSPACE/output/ 2>/dev/null || true

          echo "收集 luci-app-ttyd..."
          cp bin/packages/*/*/luci-app-ttyd*.ipk $GITHUB_WORKSPACE/output/ 2>/dev/null || true

          echo "收集 luci-app-diskman..."
          cp bin/packages/*/*/luci-app-diskman*.ipk $GITHUB_WORKSPACE/output/ 2>/dev/null || true

          echo "最终产物："
          ls -lh $GITHUB_WORKSPACE/output

      - name: 上传 Release（自动创建）
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "release-${{ github.run_number }}"
          name: "OpenWrt TTYD Build ${{ github.run_number }}"
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
