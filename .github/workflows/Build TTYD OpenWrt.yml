name: Auto compile TTYD with OpenWrt SDK - Detailed Logging

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  release:
    types: [published]

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai

jobs:
  job_check:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      ttyd_version: ${{ steps.check_version.outputs.latest_version }}
      has_update: ${{ steps.check_version.outputs.has_update }}
      prerelease: ${{ steps.check_version.outputs.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Check version
        id: check_version
        env:
          url_tags: https://api.github.com/repos/${{ github.repository }}/releases/latest
        run: |
          echo "ðŸ” Starting version check..."
          # æ£€æŸ¥TTYDç‰ˆæœ¬
          if [ -f "package/ttyd/Makefile" ]; then
            echo "ðŸ“ Found package/ttyd/Makefile"
            cd package/ttyd
            ttyd_version=$(awk -F '=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' Makefile | tr -d ' ')
          elif [ -f "ttyd/Makefile" ]; then
            echo "ðŸ“ Found ttyd/Makefile"
            cd ttyd
            ttyd_version=$(awk -F '=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' Makefile | tr -d ' ')
          else
            echo "âš ï¸ No Makefile found, using timestamp as version"
            ttyd_version=$(date +%Y%m%d-%H%M%S)
          fi
          
          echo "ðŸ“¦ Detected version: ${ttyd_version}"
          echo "latest_version=${ttyd_version}" >> $GITHUB_OUTPUT

          prerelease=$([ "${{ github.ref_name }}" == "main" ] && echo false || echo true)
          echo "prerelease=${prerelease}" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "ðŸŽ¯ Release event detected, forcing update"
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸŒ Checking remote releases..."
            remote_latest_version=$(wget -qO- -t1 -T2 ${url_tags} | jq -r '.tag_name')
            if [ -z "$remote_latest_version" ] || [ "$remote_latest_version" = "null" ]; then
              echo "âŒ Failed to fetch remote tags, assuming update needed"
              echo "has_update=true" >> $GITHUB_OUTPUT
            elif [ "$ttyd_version" = "$remote_latest_version" ]; then
              echo "âœ… No update needed (local: $ttyd_version, remote: $remote_latest_version)"
              echo "has_update=false" >> $GITHUB_OUTPUT
            else
              echo "ðŸ”„ Update needed (local: $ttyd_version, remote: $remote_latest_version)"
              echo "has_update=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Prepare release info
        if: steps.check_version.outputs.has_update == 'true'
        run: |
          echo "ðŸ“ Preparing release info..."
          echo "## :mega: TTYD Auto Build Update" >> release.txt
          echo "### Build Information" >> release.txt
          echo "**:minidisc: TTYD Version: ${{steps.check_version.outputs.latest_version}}**" >> release.txt
          echo "**:calendar: Build Date: $(date +'%Y-%m-%d %H:%M:%S')**" >> release.txt
          echo "**:gear: Build Arch: Multiple architectures**" >> release.txt
          touch release.txt

      - name: Generate new tag & release
        if: steps.check_version.outputs.has_update == 'true' && github.event_name != 'release'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{steps.check_version.outputs.latest_version}}
          target_commitish: ${{ github.ref_name }}
          prerelease: ${{steps.check_version.outputs.prerelease}}
          body_path: release.txt

  job_auto_compile:
    needs: job_check
    if: needs.job_check.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    name: Build TTYD (${{ matrix.ver }}-${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Stable releases (IPK packages)
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa53/openwrt-sdk-24.10.4-mvebu-cortexa53_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa72/openwrt-sdk-24.10.4-mvebu-cortexa72_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          # Snapshot releases (APK packages)
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa53/openwrt-sdk-mvebu-cortexa53_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa72/openwrt-sdk-mvebu-cortexa72_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

    steps:
      - name: Checkout repository
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          echo "ðŸ”§ Installing build dependencies..."
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          echo "ðŸ“¦ Updating package lists..."
          sudo -E apt-get -qq update
          echo "ðŸ“¦ Installing build tools..."
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          echo "ðŸ§¹ Cleaning up..."
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          echo "âœ… Build dependencies installed"

      - name: Download and extract SDK
        run: |
          echo "ðŸ“¥ Downloading SDK for ${{ matrix.platform }} (${{ matrix.ver }})..."
          echo "ðŸ”— SDK URL: ${{ matrix.url_sdk }}"
          wget -q --show-progress ${{ matrix.url_sdk }}
          file_name=$(echo ${{ matrix.url_sdk }} | awk -F/ '{print $NF}')
          echo "ðŸ“¦ File: $file_name"
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            echo "ðŸ“‚ Extracting .tar.xz..."
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            echo "ðŸ“‚ Extracting .tar.zst..."
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "âŒ Unsupported file format: $file_name"
            exit 1
          fi
          cd sdk
          echo "âœ… SDK extracted successfully"
          echo "ðŸ“ SDK contents:"
          ls -la

      - name: SSH connection to Actions
        uses: mxschmitt/action-tmate@v3
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false') || contains(github.event.action, 'ssh')

      - name: Remove existing TTYD packages from SDK
        run: |
          cd sdk
          echo "ðŸ—‘ï¸ Removing existing TTYD related packages from SDK..."
          
          echo "ðŸ” Checking for existing packages..."
          find feeds/packages -name "*libuv*" -o -name "*libwebsockets*" -o -name "*ttyd*" | head -10
          find feeds/luci -name "*ttyd*" | head -10
          
          # Remove libuv if exists
          echo "ðŸ§¹ Removing libuv..."
          rm -rf feeds/packages/libs/libuv
          rm -rf package/feeds/packages/libuv
          
          # Remove libwebsockets if exists
          echo "ðŸ§¹ Removing libwebsockets..."
          rm -rf feeds/packages/libs/libwebsockets
          rm -rf package/feeds/packages/libwebsockets
          
          # Remove ttyd if exists
          echo "ðŸ§¹ Removing ttyd..."
          rm -rf feeds/packages/utils/ttyd
          rm -rf package/feeds/packages/ttyd
          
          # Remove luci-app-ttyd if exists
          echo "ðŸ§¹ Removing luci-app-ttyd..."
          rm -rf feeds/luci/applications/luci-app-ttyd
          rm -rf package/feeds/luci/luci-app-ttyd
          
          echo "âœ… Existing TTYD packages removed from SDK"

      - name: Copy custom packages to SDK
        run: |
          cd sdk
          echo "ðŸ“‹ Copying custom packages to SDK..."
          
          echo "ðŸ” Checking repository structure..."
          ls -la $GITHUB_WORKSPACE/
          if [ -d "$GITHUB_WORKSPACE/package" ]; then
            echo "ðŸ“ Found package directory"
            ls -la $GITHUB_WORKSPACE/package/
          fi
          
          # Create directory structure
          mkdir -p package/custom
          
          # Copy all packages from repository
          if [ -d "$GITHUB_WORKSPACE/package" ]; then
            echo "ðŸ“¥ Copying package directory..."
            cp -r $GITHUB_WORKSPACE/package/* package/custom/
          else
            echo "ðŸ“¥ Copying entire workspace..."
            cp -r $GITHUB_WORKSPACE/* package/custom/
          fi
          
          echo "âœ… Custom packages copied to SDK"
          echo "ðŸ“ Custom packages contents:"
          ls -la package/custom/

      - name: Configure SDK
        run: |
          cd sdk
          echo "âš™ï¸ Configuring SDK..."
          
          # Update feeds to github source
          echo "ðŸ”„ Updating feeds to GitHub source..."
          sed -i \
              -e 's|git\.openwrt\.org/feed|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/project|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/openwrt|github.com/openwrt|g' \
              "feeds.conf.default"

          echo "ðŸ“‹ Updated feeds.conf.default:"
          cat feeds.conf.default | head -20

          # Update feeds
          echo "ðŸ”„ Updating feeds..."
          ./scripts/feeds update -a
          echo "ðŸ“¦ Installing feeds..."
          ./scripts/feeds install -a

          echo "ðŸ” Checking installed packages..."
          find package/feeds -name "*libuv*" -o -name "*libwebsockets*" -o -name "*ttyd*" | head -10

          # Apply patches if needed
          echo "ðŸ”§ Applying patches..."

          # Update golang and rust versions if needed
          rm -rf temp_resp
          git clone -b master --single-branch https://github.com/openwrt/packages.git temp_resp
          if [ -d "feeds/packages/lang/golang" ]; then
            echo "ðŸ”„ Updating golang version"
            rm -rf feeds/packages/lang/golang
            cp -r temp_resp/lang/golang feeds/packages/lang
          fi
          if [ -d "feeds/packages/lang/rust" ]; then
            echo "ðŸ”„ Updating rust version"
            rm -rf feeds/packages/lang/rust
            cp -r temp_resp/lang/rust feeds/packages/lang
          fi
          rm -rf temp_resp

          # Update patch-kernel.sh
          git clone -b main --single-branch https://github.com/openwrt/openwrt.git temp_resp
          cp -f temp_resp/scripts/patch-kernel.sh scripts/
          rm -rf temp_resp

          echo "âœ… Patch application completed"

          # Configure build
          echo "ðŸ“ Configuring build..."
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          
          # Enable packages
          echo "CONFIG_PACKAGE_libuv=y" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=y" >> .config
          echo "CONFIG_PACKAGE_ttyd=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config

          echo "ðŸ“‹ .config contents:"
          cat .config

          echo "ðŸ”§ Running defconfig..."
          make defconfig

          echo "âœ… SDK configuration completed"

      - name: Build Stage 1 - Dependencies
        run: |
          cd sdk
          echo "ðŸ—ï¸ STAGE 1: Building dependencies..."
          
          echo "ðŸ” Checking available packages..."
          find package/custom -name "Makefile" | head -10
          
          # Build libuv first
          if [ -d "package/custom/libuv" ]; then
            echo "ðŸ”¨ Building libuv..."
            echo "ðŸ“ libuv Makefile:"
            cat package/custom/libuv/Makefile | head -20
            make package/custom/libuv/compile -j$(nproc) V=sc
            LIBUV_RESULT=$?
            if [ $LIBUV_RESULT -eq 0 ]; then
              echo "âœ… libuv built successfully"
            else
              echo "âŒ libuv build failed with exit code $LIBUV_RESULT"
              exit $LIBUV_RESULT
            fi
          else
            echo "âŒ libuv directory not found"
            exit 1
          fi
          
          echo "â³ Waiting 5 seconds before next build..."
          sleep 5
          
          # Build libwebsockets-full second
          if [ -d "package/custom/libwebsockets-full" ]; then
            echo "ðŸ”¨ Building libwebsockets-full..."
            echo "ðŸ“ libwebsockets-full Makefile:"
            cat package/custom/libwebsockets-full/Makefile | head -20
            make package/custom/libwebsockets-full/compile -j$(nproc) V=sc
            LIBWEBSOCKETS_RESULT=$?
            if [ $LIBWEBSOCKETS_RESULT -eq 0 ]; then
              echo "âœ… libwebsockets-full built successfully"
            else
              echo "âŒ libwebsockets-full build failed with exit code $LIBWEBSOCKETS_RESULT"
              exit $LIBWEBSOCKETS_RESULT
            fi
          else
            echo "âŒ libwebsockets-full directory not found"
            exit 1
          fi

          echo "âœ… Stage 1 completed - All dependencies built"

      - name: Verify Stage 1 Build
        run: |
          cd sdk
          echo "ðŸ” STAGE 1 VERIFICATION: Checking built dependencies..."
          
          echo "ðŸ“ Checking staging directory for libuv:"
          find staging_dir -name "*libuv*" -type f | head -10 || echo "No libuv files found"
          
          echo "ðŸ“ Checking staging directory for libwebsockets:"
          find staging_dir -name "*libwebsockets*" -type f | head -10 || echo "No libwebsockets files found"
          
          echo "ðŸ“ Checking bin directory for packages:"
          find bin -name "*.ipk" -o -name "*.apk" | head -10 || echo "No package files found"
          
          echo "âœ… Stage 1 verification completed"

      - name: Build Stage 2 - TTYD and LuCI
        id: build_stage2
        run: |
          cd sdk
          echo "ðŸ—ï¸ STAGE 2: Building TTYD and LuCI app..."
          
          # Build ttyd
          if [ -d "package/custom/ttyd" ]; then
            echo "ðŸ”¨ Building ttyd..."
            echo "ðŸ“ ttyd Makefile:"
            cat package/custom/ttyd/Makefile | head -20
            
            echo "ðŸ” Checking dependencies for ttyd..."
            find staging_dir -name "libuv.so*" -o -name "libwebsockets.so*" | head -10
            
            make package/custom/ttyd/compile -j$(nproc) V=sc
            TTYD_RESULT=$?
            if [ $TTYD_RESULT -eq 0 ]; then
              echo "âœ… ttyd built successfully"
            else
              echo "âŒ ttyd build failed with exit code $TTYD_RESULT"
              echo "ðŸ“‹ Last 50 lines of build log:"
              tail -50 build_dir/target-*/ttyd*/log*
              exit $TTYD_RESULT
            fi
          else
            echo "âŒ ttyd directory not found"
            exit 1
          fi
          
          echo "â³ Waiting 5 seconds before next build..."
          sleep 5
          
          # Build luci-app-ttyd
          if [ -d "package/custom/luci-app-ttyd" ]; then
            echo "ðŸ”¨ Building luci-app-ttyd..."
            echo "ðŸ“ luci-app-ttyd Makefile:"
            cat package/custom/luci-app-ttyd/Makefile | head -20
            
            make package/custom/luci-app-ttyd/compile -j$(nproc) V=sc
            LUCI_RESULT=$?
            if [ $LUCI_RESULT -eq 0 ]; then
              echo "âœ… luci-app-ttyd built successfully"
            else
              echo "âŒ luci-app-ttyd build failed with exit code $LUCI_RESULT"
              exit $LUCI_RESULT
            fi
          else
            echo "âš ï¸ luci-app-ttyd directory not found, skipping"
          fi

          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Stage 2 completed - All packages built"

      - name: Verify Final Build
        run: |
          cd sdk
          echo "ðŸ” FINAL VERIFICATION: Checking all built packages..."
          
          echo "ðŸ“¦ All built packages:"
          find bin -name "*.ipk" -o -name "*.apk" | sort
          
          echo "ðŸ“Š Package sizes:"
          find bin -name "*.ipk" -o -name "*.apk" -exec ls -lh {} \;
          
          echo "ðŸ” TTYD related packages:"
          find bin -name "*ttyd*" -o -name "*libuv*" -o -name "*libwebsockets*" | sort
          
          echo "âœ… Final verification completed"

      - name: Collect compiled packages
        id: collect
        if: steps.build_stage2.outputs.status == 'success'
        run: |
          cd sdk
          echo "ðŸ“¦ Collecting compiled packages..."
          mkdir -p upload/packages
          
          # Find and copy all compiled packages
          echo "ðŸ” Searching for compiled packages..."
          find bin -name "*.ipk" -o -name "*.apk" | while read file; do
            if echo "$file" | grep -q -E "(libuv|libwebsockets|ttyd|luci-app-ttyd)"; then
              cp -v "$file" upload/packages/
            fi
          done
          
          echo "ðŸ“‹ Collected packages:"
          ls -la upload/packages/
          
          # Create archive with architecture info
          cd upload/packages
          echo "ðŸ—œï¸ Creating archive..."
          zip -r ../ttyd_${{ matrix.ver }}_${{ matrix.platform }}.zip ./*
          cd ..
          
          echo "ðŸ“ Archive contents:"
          ls -la
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Package collection completed"

      - name: Generate package info
        id: info
        if: steps.build_stage2.outputs.status == 'success'
        run: |
          cd sdk
          echo "ðŸ“ Generating package info..."
          echo "### TTYD Packages Version" >> release_info.txt
          echo "**Package**|**Version**" >> release_info.txt
          echo "-|-" >> release_info.txt

          # Get versions from Makefiles
          for pkg in libuv libwebsockets-full ttyd luci-app-ttyd; do
            if [ -f "package/custom/$pkg/Makefile" ]; then
              version=$(awk -F '=' '/PKG_VERSION:=/{v=$2} /PKG_RELEASE:=/{r=$2} END{print v"-"r}' package/custom/$pkg/Makefile | tr -d ' ')
              echo "**$pkg**|**$version**" >> release_info.txt
              echo "ðŸ“¦ $pkg version: $version"
            elif [ -f "package/custom/package/$pkg/Makefile" ]; then
              version=$(awk -F '=' '/PKG_VERSION:=/{v=$2} /PKG_RELEASE:=/{r=$2} END{print v"-"r}' package/custom/package/$pkg/Makefile | tr -d ' ')
              echo "**$pkg**|**$version**" >> release_info.txt
              echo "ðŸ“¦ $pkg version: $version"
            else
              echo "âš ï¸ $pkg Makefile not found"
            fi
          done

          echo "ðŸ“‹ Release info:"
          cat release_info.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload packages to release
        uses: softprops/action-gh-release@v2
        if: steps.info.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.job_check.outputs.ttyd_version }}
          files: |
            ${{ env.FIRMWARE }}/ttyd_${{ matrix.ver }}_${{ matrix.platform }}.zip
            ${{ env.FIRMWARE }}/packages/*.ipk
            ${{ env.FIRMWARE }}/packages/*.apk

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-${{ matrix.platform }}-${{ matrix.ver }}
          path: |
            ${{ env.FIRMWARE }}/packages/*
            ${{ env.FIRMWARE }}/ttyd_${{ matrix.ver }}_${{ matrix.platform }}.zip
          if-no-files-found: warn
          retention-days: 7

      - name: Upload build logs for debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.platform }}-${{ matrix.ver }}
          path: |
            sdk/build_dir/**/log*
            sdk/build_dir/**/*.log
          retention-days: 7
