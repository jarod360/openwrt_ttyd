name: Build TTYD for OpenWrt

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: "x86_64"
            sdk_url: "https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          - platform: "aarch64_cortex-a53" 
            sdk_url: "https://downloads.openwrt.org/releases/22.03.5/targets/armvirt/64/openwrt-sdk-22.03.5-armvirt-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          - platform: "aarch64_cortex-a72"
            sdk_url: "https://downloads.openwrt.org/releases/22.03.5/targets/mvebu/cortexa72/openwrt-sdk-22.03.5-mvebu-cortexa72_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          - platform: "arm_cortex-a7"
            sdk_url: "https://downloads.openwrt.org/releases/22.03.5/targets/sunxi/cortexa7/openwrt-sdk-22.03.5-sunxi-cortexa7_gcc-11.2.0_musl_eabi.Linux-x86_64.tar.xz"
          - platform: "mips_24kc"
            sdk_url: "https://downloads.openwrt.org/releases/22.03.5/targets/ath79/generic/openwrt-sdk-22.03.5-ath79-generic_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          - platform: "mipsel_24kc"
            sdk_url: "https://downloads.openwrt.org/releases/22.03.5/targets/ramips/mt76x8/openwrt-sdk-22.03.5-ramips-mt76x8_gcc-11.2.0_musl.Linux-x86_64.tar.xz"

    name: Build ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libssl-dev unzip gawk zlib1g-dev file python3

      - name: Download and extract SDK
        run: |
          wget ${{ matrix.sdk_url }} -O sdk.tar.xz
          mkdir sdk
          tar -xf sdk.tar.xz -C sdk --strip-components=1

      - name: Copy packages to SDK
        run: |
          cd sdk
          cp -r ../package/* package/ || true
          echo "Packages copied:"
          ls -la package/

      - name: Configure build
        run: |
          cd sdk
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config  
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_PACKAGE_libuv=y" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=y" >> .config
          echo "CONFIG_PACKAGE_ttyd=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
          make defconfig

      - name: Build libuv
        run: |
          cd sdk
          make package/libuv/compile -j$(nproc) V=0

      - name: Build libwebsockets
        run: |
          cd sdk
          make package/libwebsockets-full/compile -j$(nproc) V=0

      - name: Build ttyd
        run: |
          cd sdk
          make package/ttyd/compile -j$(nproc) V=s

      - name: Build luci app
        run: |
          cd sdk
          make package/luci-app-ttyd/compile -j$(nproc) V=0

      - name: Collect packages
        run: |
          cd sdk
          mkdir -p ../artifacts/${{ matrix.platform }}
          find bin -name "*.ipk" -exec cp {} ../artifacts/${{ matrix.platform }}/ \;
          echo "Built packages for ${{ matrix.platform }}:"
          ls -la ../artifacts/${{ matrix.platform }}/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-${{ matrix.platform }}
          path: artifacts/${{ matrix.platform }}/*.ipk

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/**/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
