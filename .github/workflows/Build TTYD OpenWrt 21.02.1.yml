name: ä¸º RK3568 æ„å»ºå¸¦ HTTPS (TLS) çš„ TTYDï¼Œä½¿ç”¨ OpenWrt 23.05.7

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿æ¥åˆ° Actions'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai
  # ä½¿ç”¨ OpenWrt 23.05.7 SDK for Rockchip ARMv8
  SDK_URL: https://downloads.openwrt.org/releases/23.05.7/targets/rockchip/armv8/openwrt-sdk-23.05.7-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

      - name: ä¸‹è½½å¹¶è§£å‹ OpenWrt 23.05.7 SDK
        run: |
          wget -q ${{ env.SDK_URL }}
          file_name=$(echo ${{ env.SDK_URL }} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_name"
            exit 1
          fi
          echo "SDK_DIR=$PWD/sdk" >> $GITHUB_ENV

      - name: å¤åˆ¶è‡ªå®šä¹‰è½¯ä»¶åŒ…åˆ° SDK
        run: |
          # æ£€æŸ¥åŒ…ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "libwebsockets-full" ]; then
            cp -r libwebsockets-full $SDK_DIR/package/
            echo "âœ… libwebsockets-full åŒ…å·²å¤åˆ¶"
          else
            echo "âŒ libwebsockets-full ç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ -d "ttyd" ]; then
            cp -r ttyd $SDK_DIR/package/
            echo "âœ… ttyd åŒ…å·²å¤åˆ¶"
          else
            echo "âŒ ttyd ç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi

          # å¤åˆ¶ luci-app-ttyd åŒ…
          if [ -d "luci-app-ttyd" ]; then
            cp -r luci-app-ttyd $SDK_DIR/package/
            echo "âœ… luci-app-ttyd åŒ…å·²å¤åˆ¶"
          else
            echo "âŒ luci-app-ttyd ç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi

      - name: SSH è¿æ¥åˆ° Actions (è°ƒè¯•)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: ä¸º OpenWrt 23.05.7 è®¾ç½® feeds å’Œé…ç½®
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # é…ç½®ä¸º RK3568 ç›®æ ‡ - OpenWrt 23.05.7
          echo "CONFIG_TARGET_rockchip=y" > .config
          echo "CONFIG_TARGET_rockchip_armv8=y" >> .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=m" >> .config
          echo "CONFIG_PACKAGE_ttyd=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=m" >> .config
          
          make defconfig

      - name: ä¸‹è½½è½¯ä»¶åŒ…æºç 
        run: |
          cd $SDK_DIR
          make package/libwebsockets-full/download V=s
          make package/ttyd/download V=s
          make package/luci-app-ttyd/download V=s
          find dl -size -1024c -exec ls -l {} \; || true

      - name: ç¼–è¯‘ libwebsockets-full
        id: compile_libwebsockets
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ libwebsockets-full..."
          make package/libwebsockets-full/clean V=s
          if make package/libwebsockets-full/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… libwebsockets-full ç¼–è¯‘æˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ libwebsockets-full ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ç¼–è¯‘ ttyd
        id: compile_ttyd
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ ttyd..."
          make package/ttyd/clean V=s
          if make package/ttyd/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… ttyd ç¼–è¯‘æˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ ttyd ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ç¼–è¯‘ luci-app-ttyd
        id: compile_luci_app_ttyd
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ luci-app-ttyd..."
          make package/luci-app-ttyd/clean V=s
          if make package/luci-app-ttyd/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… luci-app-ttyd ç¼–è¯‘æˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ luci-app-ttyd ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: æ”¶é›†æ„å»ºäº§ç‰©
        if: steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.compile_luci_app_ttyd.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          mkdir -p upload
          
          # æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³çš„ IPK æ–‡ä»¶
          echo "=== æœç´¢ IPK æ–‡ä»¶ ==="
          find bin -name "*ttyd*.ipk" -type f | while read file; do
            echo "æ‰¾åˆ° ttyd IPK: $file"
            cp "$file" upload/
          done
          
          find bin -name "*libwebsockets*.ipk" -type f | while read file; do
            echo "æ‰¾åˆ° libwebsockets IPK: $file"
            cp "$file" upload/
          done

          # æŸ¥æ‰¾ luci-app-ttyd IPK æ–‡ä»¶
          find bin -name "*luci-app-ttyd*.ipk" -type f | while read file; do
            echo "æ‰¾åˆ° luci-app-ttyd IPK: $file"
            cp "$file" upload/
          done
          
          # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== æœç´¢äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          find build_dir -name "ttyd" -type f | while read file; do
            if file "$file" | grep -q "ELF"; then
              echo "æ‰¾åˆ° ELF äºŒè¿›åˆ¶æ–‡ä»¶: $file"
              cp "$file" upload/ttyd
              chmod +x upload/ttyd
              break
            fi
          done
          
          echo "ğŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -la upload/

      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯
        id: release_info
        if: steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.compile_luci_app_ttyd.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          # è·å–å½“å‰æ—¥æœŸæ—¶é—´
          BUILD_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          
          cat > upload/RELEASE_INFO.md << EOF
          ## ğŸŒ é€‚ç”¨äº RK3568 çš„ TTYD (HTTPS/TLS) æ„å»º - OpenWrt 23.05.7
          
          ### æ„å»ºä¿¡æ¯
          - **æ„å»ºæ—¥æœŸ**: $BUILD_DATE
          - **OpenWrt ç‰ˆæœ¬**: 23.05.7
          - **ç›®æ ‡å¹³å°**: Rockchip ARMv8 (RK3568)
          - **ä»£ç åº“**: ${{ github.repository }}
          - **æäº¤**: ${{ github.sha }}
          
          ### åŒ…å«çš„è½¯ä»¶åŒ…
          - **ttyd** - é€šè¿‡ç½‘ç»œå…±äº«æ‚¨çš„ç»ˆç«¯ï¼Œæ”¯æŒ TLS/SSL
          - **libwebsockets-full** - å®Œæ•´çš„ WebSocket åº“ï¼Œæ”¯æŒ OpenSSL
          - **luci-app-ttyd** - ttyd çš„ LuCI ç½‘é¡µç•Œé¢
          
          ### å®‰è£…è¯´æ˜
          1. å°† IPK æ–‡ä»¶ä¸Šä¼ åˆ°æ‚¨çš„ RK3568 OpenWrt 23.05.7 è®¾å¤‡
          2. å®‰è£…è½¯ä»¶åŒ… (æŒ‰é¡ºåºå®‰è£…):
          \`\`\`bash
          opkg install libwebsockets-full_*.ipk
          opkg install ttyd_*.ipk
          opkg install luci-app-ttyd_*.ipk
          \`\`\`
          
          3. å¯ç”¨æœåŠ¡:
          \`\`\`bash
          /etc/init.d/ttyd enable
          /etc/init.d/ttyd start
          \`\`\`
          
          4. é€šè¿‡ LuCI ç•Œé¢é…ç½® SSL:
          - è®¿é—® LuCI ç®¡ç†ç•Œé¢
          - è¿›å…¥ "æœåŠ¡" -> "ç»ˆç«¯"
          - å¯ç”¨ SSL/TLS å¹¶é…ç½®è¯ä¹¦è·¯å¾„
          
          5. æˆ–è€…æ‰‹åŠ¨ç”Ÿæˆ SSL è¯ä¹¦:
          \`\`\`bash
          # åˆ›å»º SSL ç›®å½•
          mkdir -p /etc/ssl
          
          # ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
          openssl req -x509 -newkey rsa:2048 \\
            -keyout /etc/ssl/ttyd.key \\
            -out /etc/ssl/ttyd.crt \\
            -days 365 -nodes \\
            -subj '/CN=localhost'
            
          # ä½¿ç”¨ SSL å¯åŠ¨ ttyd
          ttyd --ssl --ssl-cert /etc/ssl/ttyd.crt --ssl-key /etc/ssl/ttyd.key bash
          \`\`\`
          
          6. é€šè¿‡æµè§ˆå™¨è®¿é—®: \`https://æ‚¨çš„è®¾å¤‡IP:7681\`
          
          ### æ–‡ä»¶åˆ—è¡¨
          EOF
          
          echo '```' >> upload/RELEASE_INFO.md
          ls -la upload/ >> upload/RELEASE_INFO.md
          echo '```' >> upload/RELEASE_INFO.md
          
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ç”ŸæˆåŒ…å«æ—¥æœŸå’Œéšæœºæ•°çš„å”¯ä¸€æ ‡ç­¾
        id: tag_generator
        if: steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.compile_luci_app_ttyd.outputs.status == 'success' && steps.release_info.outputs.status == 'success'
        run: |
          # ç”Ÿæˆéšæœºå››ä½æ•°
          RANDOM_NUM=$(shuf -i 1000-9999 -n 1)
          # æ„å»ºæ ‡ç­¾ï¼šOpenWrt-ttyd-å¹´æœˆæ—¥-éšæœºå››ä½æ•°
          BUILD_TAG="OpenWrt-ttyd-$(date +%Y%m%d)-${RANDOM_NUM}"
          echo "ç”Ÿæˆçš„æ ‡ç­¾: $BUILD_TAG"
          echo "tag_name=$BUILD_TAG" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub å‘å¸ƒ
        if: steps.tag_generator.outputs.tag_name
        run: |
          echo "ä½¿ç”¨æ ‡ç­¾åˆ›å»ºå‘å¸ƒ: ${{ steps.tag_generator.outputs.tag_name }}"
          gh release create "${{ steps.tag_generator.outputs.tag_name }}" \
            --title "OpenWrt 23.05.7 TTYD HTTPS æ„å»º for RK3568 $(date +'%Y-%m-%d')" \
            --notes-file $SDK_DIR/upload/RELEASE_INFO.md \
            $SDK_DIR/upload/*.ipk \
            $SDK_DIR/upload/ttyd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ äº§ç‰©åˆ° GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-https-packages-23.05.7
          path: |
            $SDK_DIR/upload/*.ipk
            $SDK_DIR/upload/ttyd
          if-no-files-found: warn

      - name: è°ƒè¯•æ„å»ºç›®å½•ç»“æ„
        if: always()
        run: |
          cd $SDK_DIR
          echo "ğŸ” è°ƒè¯•æ„å»ºç›®å½•ç»“æ„..."
          echo "=== æ‰€æœ‰ IPK æ–‡ä»¶ ==="
          find bin -name "*.ipk" -type f | head -20
          echo "=== æ„å»ºç›®å½• ==="
          find build_dir -name "*ttyd*" -type d | head -10
          find build_dir -name "*libwebsockets*" -type d | head -10
          find build_dir -name "*luci-app-ttyd*" -type d | head -10
