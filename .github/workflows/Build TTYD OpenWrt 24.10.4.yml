name: ä¸ºå¤šç§æ¶æ„æ„å»ºå¸¦ HTTPS (TLS) çš„ TTYD

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿æ¥åˆ° Actionsï¼ˆè°ƒè¯•ç”¨ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai

jobs:
  build-packages:
    name: Build TTYD Package - ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        # å®šä¹‰ç›®æ ‡æ¶æ„
        arch:
          - x86_64
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_cortex-a15_neon-vfpv4
          - mips_24kc
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_riscv64
        # å®šä¹‰SDKç‰ˆæœ¬
        sdk:
          - "24.10.4"  # ç”¨äºç”ŸæˆIPKåŒ…
          - "SNAPSHOT" # ç”¨äºç”ŸæˆAPKåŒ…

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: å‡†å¤‡è‡ªå®šä¹‰åŒ…ç›®å½•
        run: |
          echo "=== å‡†å¤‡è‡ªå®šä¹‰åŒ…ç›®å½• ==="
          # ç¡®ä¿ package ç›®å½•å­˜åœ¨
          mkdir -p package
          echo "âœ… package ç›®å½•å·²å‡†å¤‡"

      - name: æ„å»º OpenWrt åŒ…ï¼ˆä½¿ç”¨è‡ªå®šä¹‰åŒ…ï¼‰
        uses: openwrt/gh-action-sdk@v9
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          NO_SHFMT_CHECK: true
          # è®¾ç½®è·³è¿‡è¡¥ä¸æ£€æŸ¥ï¼Œé¿å… "Dirty patches" é”™è¯¯
          REFRESH_CHECK: 0
          # æ˜ç¡®æŒ‡å®šä½¿ç”¨ä½ çš„è‡ªå®šä¹‰åŒ…
          PACKAGES: "libuv libwebsockets-full ttyd luci-app-ttyd"
          # ç¦ç”¨æ‰€æœ‰å®˜æ–¹ feedsï¼Œå¼ºåˆ¶ä½¿ç”¨ä½ çš„è‡ªå®šä¹‰åŒ…
          DISABLE_FEEDS: "1"
          V: sc

      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          echo "=== æ£€æŸ¥æ„å»ºäº§ç‰© ==="
          find . -name "*.ipk" -o -name "*.apk" | head -20 || echo "æœªæ‰¾åˆ°åŒ…æ–‡ä»¶"
          echo "ğŸ“ æ„å»ºç›®å½•ç»“æ„:"
          find bin/ -type d | head -20

      - name: ä¸Šä¼ åˆ° Release èµ„äº§
        run: |
          set -x
          echo "æ£€æŸ¥å·²æ„å»ºçš„åŒ…..."
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©ç›®å½•
          find bin -name "*.ipk" -o -name "*.apk" | head -20 || echo "æœªæ‰¾åˆ°åŒ…æ–‡ä»¶"
          
          # ä¸Šä¼ IPKæ–‡ä»¶
          if ls bin/packages/${{ matrix.arch }}/action/*.ipk 1> /dev/null 2>&1; then
            echo "ä¸Šä¼ IPKæ–‡ä»¶..."
            for ipk_file in bin/packages/${{ matrix.arch }}/action/*.ipk; do
              echo "ä¸Šä¼ : $(basename $ipk_file)"
              gh release upload --repo ${{ github.repository }} ${{ github.event.release.tag_name }} "$ipk_file"
            done
          else
            echo "æœªæ‰¾åˆ°IPKæ–‡ä»¶"
            # æ˜¾ç¤ºç›®å½•ç»“æ„ç”¨äºè°ƒè¯•
            find bin/packages/ -type d | head -20
          fi

          # å¤„ç†APKæ–‡ä»¶
          if ls bin/packages/${{ matrix.arch }}/action/*.apk 1> /dev/null 2>&1; then
            echo "å¤„ç†APKæ–‡ä»¶..."
            for apk_file in bin/packages/${{ matrix.arch }}/action/*.apk; do
              filename=$(basename "$apk_file")

              # è·³è¿‡luciåŒ…ï¼ˆä¿æŒåŸå§‹åç§°ï¼‰
              if [[ "$filename" == luci-* ]]; then
                echo "ä¸Šä¼ luciåŒ…: $filename"
                gh release upload --repo ${{ github.repository }} ${{ github.event.release.tag_name }} "$apk_file"
                continue
              fi

              # ä¸ºéluciåŒ…æ·»åŠ æ¶æ„åç¼€
              new_filename="${filename%.apk}_${{ matrix.arch }}.apk"
              echo "é‡å‘½å: $filename -> $new_filename"
              cp "$apk_file" "/tmp/$new_filename"
              gh release upload --repo ${{ github.repository }} ${{ github.event.release.tag_name }} "/tmp/$new_filename"
            done
          else
            echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ å·¥ä½œæµäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-packages-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/action/*.ipk
            bin/packages/${{ matrix.arch }}/action/*.apk
          if-no-files-found: warn

      - name: SSH è¿æ¥åˆ° Actions (è°ƒè¯•)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}
