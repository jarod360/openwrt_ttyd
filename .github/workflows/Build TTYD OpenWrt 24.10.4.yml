name: 为多种架构构建带 HTTPS (TLS) 的 TTYD

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH 连接到 Actions（调试用）'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai

jobs:
  build-packages:
    name: Build TTYD Package - ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        # 定义目标架构
        arch:
          - x86_64
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_cortex-a15_neon-vfpv4
          - mips_24kc
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_riscv64
        # 定义SDK版本
        sdk:
          - "24.10.4"  # 用于生成IPK包
          - "SNAPSHOT" # 用于生成APK包

    steps:
      - name: 检出代码库
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: 构建 OpenWrt 包
        uses: openwrt/gh-action-sdk@v9
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          NO_SHFMT_CHECK: true
          # 根据需要构建的包来设置PACKAGES变量
          PACKAGES: "libuv libwebsockets-full ttyd luci-app-ttyd"
          V: sc

      - name: 上传到 Release 资产
        run: |
          set -x
          echo "检查已构建的包..."
          ls -la bin/packages/${{ matrix.arch }}/action/ || echo "目录未找到"

          # 上传IPK文件（IPK文件名已包含架构信息）
          if ls bin/packages/${{ matrix.arch }}/action/*.ipk 1> /dev/null 2>&1; then
            echo "上传IPK文件..."
            gh release upload --repo ${{ github.repository }} ${{ github.event.release.tag_name }} bin/packages/${{ matrix.arch }}/action/*.ipk
          else
            echo "未找到IPK文件"
          fi

          # 处理并上传APK文件（为文件名添加架构后缀）
          if ls bin/packages/${{ matrix.arch }}/action/*.apk 1> /dev/null 2>&1; then
            echo "处理APK文件..."
            for apk_file in bin/packages/${{ matrix.arch }}/action/*.apk; do
              filename=$(basename "$apk_file")

              # 跳过luci包（保持原始名称）
              if [[ "$filename" == luci-* ]]; then
                echo "上传luci包: $filename"
                gh release upload --repo ${{ github.repository }} ${{ github.event.release.tag_name }} "$apk_file"
                continue
              fi

              # 为非luci包添加架构后缀
              # 例如：ttyd-1.0.0-r1.apk -> ttyd-1.0.0-r1_aarch64_cortex-a53.apk
              new_filename="${filename%.apk}_${{ matrix.arch }}.apk"
              echo "重命名: $filename -> $new_filename"
              cp "$apk_file" "/tmp/$new_filename"
              gh release upload --repo ${{ github.repository }} ${{ github.event.release.tag_name }} "/tmp/$new_filename"
            done
          else
            echo "未找到APK文件"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
