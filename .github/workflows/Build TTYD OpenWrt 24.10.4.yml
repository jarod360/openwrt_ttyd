name: Auto compile TTYD with OpenWrt SDK

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  release:
    types: [published]

env:
  TZ: Asia/Shanghai
  PACKAGE_NAMES: "libuv libwebsockets-full ttyd luci-app-ttyd"

jobs:
  job_check:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      ttyd_version: ${{ steps.check_version.outputs.latest_version }}
      has_update: ${{ steps.check_version.outputs.has_update }}
      prerelease: ${{ steps.check_version.outputs.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Check version
        id: check_version
        env:
          url_tags: https://api.github.com/repos/${{ github.repository }}/releases/latest
        run: |
          # 检查TTYD版本
          if [ -f "package/ttyd/Makefile" ]; then
            cd package/ttyd
            ttyd_version=$(awk -F '=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' Makefile | tr -d ' ')
          elif [ -f "ttyd/Makefile" ]; then
            cd ttyd
            ttyd_version=$(awk -F '=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' Makefile | tr -d ' ')
          else
            # 如果没有找到Makefile，使用当前时间作为版本
            ttyd_version=$(date +%Y%m%d-%H%M%S)
          fi
          
          echo "latest_version=${ttyd_version}" >> $GITHUB_OUTPUT

          prerelease=$([ "${{ github.ref_name }}" == "main" ] && echo false || echo true)
          echo "prerelease=${prerelease}" >> $GITHUB_OUTPUT

          # 检查是否需要更新
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            remote_latest_version=$(wget -qO- -t1 -T2 ${url_tags} | jq -r '.tag_name')
            if [ -z "$remote_latest_version" ] || [ "$remote_latest_version" = "null" ]; then
              echo "has_update=true" >> $GITHUB_OUTPUT
            elif [ "$ttyd_version" = "$remote_latest_version" ]; then
              echo "has_update=false" >> $GITHUB_OUTPUT
            else
              echo "has_update=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Prepare release info
        if: steps.check_version.outputs.has_update == 'true'
        run: |
          echo "## :mega: TTYD Auto Build Update" >> release.txt
          echo "### Build Information" >> release.txt
          echo "**:minidisc: TTYD Version: ${{steps.check_version.outputs.latest_version}}**" >> release.txt
          echo "**:calendar: Build Date: $(date +'%Y-%m-%d %H:%M:%S')**" >> release.txt
          echo "**:gear: Build Arch: Multiple architectures**" >> release.txt
          echo "" >> release.txt
          echo "### Supported Architectures" >> release.txt
          echo "- x86_64, aarch64_cortex-a53, aarch64_cortex-a72" >> release.txt
          echo "- aarch64_generic, arm_cortex-a7_neon-vfpv4" >> release.txt
          echo "- mips_24kc, mipsel_24kc" >> release.txt
          touch release.txt

      - name: Generate new tag & release
        if: steps.check_version.outputs.has_update == 'true' && github.event_name != 'release'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{steps.check_version.outputs.latest_version}}
          target_commitish: ${{ github.ref_name }}
          prerelease: ${{steps.check_version.outputs.prerelease}}
          body_path: release.txt

  job_auto_compile:
    needs: job_check
    if: needs.job_check.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    name: Build TTYD (${{ matrix.ver }}-${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Stable releases (IPK packages)
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa53/openwrt-sdk-24.10.4-mvebu-cortexa53_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa72/openwrt-sdk-24.10.4-mvebu-cortexa72_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/sunxi/cortexa7/openwrt-sdk-24.10.4-sunxi-cortexa7_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/ath79/generic/openwrt-sdk-24.10.4-ath79-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.4/targets/ramips/rt288x/openwrt-sdk-24.10.4-ramips-rt288x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            ver: "ipk"

          # Snapshot releases (APK packages)
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa53/openwrt-sdk-mvebu-cortexa53_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/snapshots/targets/mvebu/cortexa72/openwrt-sdk-mvebu-cortexa72_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/snapshots/targets/rockchip/armv8/openwrt-sdk-rockchip-armv8_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa7/openwrt-sdk-sunxi-cortexa7_gcc-14.3.0_musl_eabi.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ath79/generic/openwrt-sdk-ath79-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/snapshots/targets/ramips/rt288x/openwrt-sdk-ramips-rt288x_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            ver: "apk"

    steps:
      - name: Checkout repository
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          echo "Install packages"
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Download and extract SDK
        run: |
          wget ${{ matrix.url_sdk }}
          file_name=$(echo ${{ matrix.url_sdk }} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "Unsupported file format: $file_name"
            exit 1
          fi
          cd sdk

      - name: SSH connection to Actions
        uses: mxschmitt/action-tmate@v3
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false') || contains(github.event.action, 'ssh')

      - name: Remove existing TTYD packages from SDK
        run: |
          cd sdk
          echo "Removing existing TTYD related packages from SDK..."
          
          # Remove libuv if exists
          rm -rf feeds/packages/libs/libuv
          rm -rf package/feeds/packages/libuv
          
          # Remove libwebsockets if exists
          rm -rf feeds/packages/libs/libwebsockets
          rm -rf package/feeds/packages/libwebsockets
          
          # Remove ttyd if exists
          rm -rf feeds/packages/utils/ttyd
          rm -rf package/feeds/packages/ttyd
          
          # Remove luci-app-ttyd if exists
          rm -rf feeds/luci/applications/luci-app-ttyd
          rm -rf package/feeds/luci/luci-app-ttyd
          
          echo "Existing TTYD packages removed from SDK"

      - name: Copy custom packages to SDK
        run: |
          cd sdk
          echo "Copying custom packages to SDK..."
          
          # Create directory structure
          mkdir -p package/custom
          
          # Copy all packages from repository
          if [ -d "$GITHUB_WORKSPACE/package" ]; then
            cp -r $GITHUB_WORKSPACE/package/* package/custom/
          else
            # If no package directory, copy everything
            cp -r $GITHUB_WORKSPACE/* package/custom/
          fi
          
          echo "Custom packages copied to SDK"
          ls -la package/custom/

      - name: Configure SDK and build
        run: |
          cd sdk
          
          # Update feeds to github source
          sed -i \
              -e 's|git\.openwrt\.org/feed|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/project|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/openwrt|github.com/openwrt|g' \
              "feeds.conf.default"

          # Update feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # Apply patches if needed
          echo "Start applying patches if any..."

          # Update golang and rust versions if needed
          rm -rf temp_resp
          git clone -b master --single-branch https://github.com/openwrt/packages.git temp_resp
          if [ -d "feeds/packages/lang/golang" ]; then
            echo "update golang version"
            rm -rf feeds/packages/lang/golang
            cp -r temp_resp/lang/golang feeds/packages/lang
          fi
          if [ -d "feeds/packages/lang/rust" ]; then
            echo "update rust version"
            rm -rf feeds/packages/lang/rust
            cp -r temp_resp/lang/rust feeds/packages/lang
          fi
          rm -rf temp_resp

          # Update patch-kernel.sh
          git clone -b main --single-branch https://github.com/openwrt/openwrt.git temp_resp
          cp -f temp_resp/scripts/patch-kernel.sh scripts/
          rm -rf temp_resp

          echo "Patch application completed"

          # Configure build - only build our custom packages
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          
          # Enable our custom packages
          echo "CONFIG_PACKAGE_libuv=y" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=y" >> .config
          echo "CONFIG_PACKAGE_ttyd=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config

          make defconfig

      - name: Compile custom TTYD packages
        id: compile
        run: |
          cd sdk
          echo "Starting compilation of custom packages..."
          
          # Compile each package individually
          for package in libuv libwebsockets-full ttyd luci-app-ttyd; do
            if [ -d "package/custom/$package" ]; then
              echo "----------- Compiling $package ---------------"
              make package/custom/$package/compile -j$(nproc) V=s
              echo "----------- Finished compiling $package ---------------"
            elif [ -d "package/custom/package/$package" ]; then
              echo "----------- Compiling $package ---------------"
              make package/custom/package/$package/compile -j$(nproc) V=s
              echo "----------- Finished compiling $package ---------------"
            else
              echo "Package $package not found in custom packages"
            fi
          done

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Collect compiled packages
        id: collect
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk
          mkdir -p upload/packages
          
          # Find and copy all compiled packages
          echo "Searching for compiled packages..."
          find bin -name "*.ipk" -o -name "*.apk" | while read file; do
            if echo "$file" | grep -q -E "(libuv|libwebsockets|ttyd)"; then
              cp "$file" upload/packages/
              echo "Copied: $(basename $file)"
            fi
          done
          
          # Create archive with architecture info
          cd upload/packages
          zip -r ../ttyd_${{ matrix.ver }}_${{ matrix.platform }}.zip ./*
          cd ..
          
          echo "Compiled packages:"
          ls -la packages/
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Generate package info
        id: info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk
          echo "### TTYD Packages Version" >> release_info.txt
          echo "**Package**|**Version**" >> release_info.txt
          echo "-|-" >> release_info.txt

          # Get versions from Makefiles
          for pkg in libuv libwebsockets-full ttyd luci-app-ttyd; do
            if [ -f "package/custom/$pkg/Makefile" ]; then
              version=$(awk -F '=' '/PKG_VERSION:=/{v=$2} /PKG_RELEASE:=/{r=$2} END{print v"-"r}' package/custom/$pkg/Makefile | tr -d ' ')
              echo "**$pkg**|**$version**" >> release_info.txt
            elif [ -f "package/custom/package/$pkg/Makefile" ]; then
              version=$(awk -F '=' '/PKG_VERSION:=/{v=$2} /PKG_RELEASE:=/{r=$2} END{print v"-"r}' package/custom/package/$pkg/Makefile | tr -d ' ')
              echo "**$pkg**|**$version**" >> release_info.txt
            fi
          done

          cat release_info.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload packages to release
        uses: softprops/action-gh-release@v2
        if: steps.info.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.job_check.outputs.ttyd_version }}
          files: |
            ${{ env.FIRMWARE }}/ttyd_${{ matrix.ver }}_${{ matrix.platform }}.zip
            ${{ env.FIRMWARE }}/packages/*.ipk
            ${{ env.FIRMWARE }}/packages/*.apk

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-${{ matrix.platform }}-${{ matrix.ver }}
          path: |
            ${{ env.FIRMWARE }}/packages/*
            ${{ env.FIRMWARE }}/ttyd_${{ matrix.ver }}_${{ matrix.platform }}.zip
          if-no-files-found: warn
          retention-days: 7
