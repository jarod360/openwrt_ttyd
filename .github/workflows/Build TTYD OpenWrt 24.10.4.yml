name: ä¸º RK3568 æž„å»ºå¸¦ HTTPS (TLS) çš„ TTYDï¼Œä½¿ç”¨ OpenWrt 24.10.4

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿žæŽ¥åˆ° Actions'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai
  SDK_URL: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

      - name: ä¸‹è½½å¹¶è§£åŽ‹ OpenWrt SDK
        run: |
          wget -q ${{ env.SDK_URL }}
          file_name=$(echo ${{ env.SDK_URL }} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_name"
            exit 1
          fi
          echo "SDK_DIR=$PWD/sdk" >> $GITHUB_ENV

      - name: å¤åˆ¶è‡ªå®šä¹‰è½¯ä»¶åŒ…åˆ° SDK
        run: |
          for pkg in libwebsockets-full ttyd luci-app-ttyd; do
            if [ -d "$pkg" ]; then
              cp -r "$pkg" $SDK_DIR/package/
              echo "âœ… $pkg åŒ…å·²å¤åˆ¶"
            else
              echo "âŒ $pkg ç›®å½•æœªæ‰¾åˆ°"
              exit 1
            fi
          done

      - name: SSH è¿žæŽ¥åˆ° Actions (è°ƒè¯•)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: æ¸…ç†å®˜æ–¹ libwebsockets åŒ…
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds uninstall libwebsockets || true
          rm -rf feeds/packages/libs/libwebsockets package/feeds/packages/libwebsockets
          find . -type d -name "libwebsockets" ! -path "*/libwebsockets-full/*" ! -path "*/dl/*" -exec rm -rf {} + || true
          rm -rf build_dir/target-*/libwebsockets* staging_dir/target-*/pkginfo/libwebsockets* || true

      - name: å®‰è£… feeds å¹¶éªŒè¯æ¸…ç†
        run: |
          cd $SDK_DIR
          ./scripts/feeds install -a
          [ ! -d "feeds/packages/libs/libwebsockets" ] || exit 1
          [ ! -d "package/feeds/packages/libwebsockets" ] || exit 1
          find package -name "*libwebsockets*" -type d

      - name: é…ç½® OpenWrt æž„å»º
        run: |
          cd $SDK_DIR
          echo "CONFIG_TARGET_rockchip=y
CONFIG_TARGET_rockchip_armv8=y
CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y
CONFIG_PACKAGE_libuv=y
CONFIG_PACKAGE_libwebsockets-full=m
CONFIG_PACKAGE_ttyd=m
CONFIG_PACKAGE_luci-app-ttyd=m
# CONFIG_PACKAGE_libwebsockets is not set
# CONFIG_PACKAGE_libwebsockets-openssl is not set
# CONFIG_PACKAGE_libwebsockets-mbedtls is not set" > .config
          make defconfig
          grep -E "CONFIG_PACKAGE_(libuv|libwebsockets)" .config

      - name: ä¸‹è½½è½¯ä»¶åŒ…æºç 
        run: |
          cd $SDK_DIR
          make package/feeds/packages/libuv/download V=s
          [ -d "package/libwebsockets-full" ] && make package/libwebsockets-full/download V=s
          make package/ttyd/download V=s
          make package/luci-app-ttyd/download V=s

      - name: ç¼–è¯‘è½¯ä»¶åŒ…
        run: |
          cd $SDK_DIR
          for pkg in libuv libwebsockets-full ttyd luci-app-ttyd; do
            make package/$pkg/clean V=s
            make package/$pkg/compile -j$(nproc) V=s || exit 1
          done
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: æ”¶é›†æž„å»ºäº§ç‰©
        run: |
          cd $SDK_DIR
          mkdir -p upload
          for pattern in "*libuv*.ipk" "*ttyd*.ipk" "*libwebsockets*.ipk" "*luci-app-ttyd*.ipk"; do
            find bin -name "$pattern" -type f -exec cp {} upload/ \;
          done
          find build_dir -name "ttyd" -type f | while read f; do
            cp "$f" upload/ttyd
            chmod +x upload/ttyd
            break
          done

      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯
        id: release_info
        run: |
          cd $SDK_DIR
          BUILD_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          LIBUV_VERSION=$(find bin -name "*libuv*.ipk" -type f | head -1 | grep -o 'libuv[^_]*' | sed 's/libuv[^0-9]*//' || echo "æœªçŸ¥ç‰ˆæœ¬")
          cat > upload/RELEASE_INFO.md << EOF
## ðŸŒ é€‚ç”¨äºŽ RK3568 çš„ TTYD (HTTPS/TLS) æž„å»º - OpenWrt 24.10.4

### æž„å»ºä¿¡æ¯
- **æž„å»ºæ—¥æœŸ**: $BUILD_DATE
- **OpenWrt ç‰ˆæœ¬**: 24.10.4
- **ç›®æ ‡å¹³å°**: Rockchip ARMv8 (RK3568)
- **ä»£ç åº“**: ${{ github.repository }}
- **æäº¤**: ${{ github.sha }}
- **libuv ç‰ˆæœ¬**: $LIBUV_VERSION
- **libwebsockets**: è‡ªå®šä¹‰å®Œæ•´ç‰ˆ

### æ–‡ä»¶åˆ—è¡¨
\`\`\`
EOF
          ls -la upload/ >> upload/RELEASE_INFO.md
          echo '```' >> upload/RELEASE_INFO.md

      - name: ç”Ÿæˆå”¯ä¸€æ ‡ç­¾
        id: tag_generator
        run: |
          RANDOM_NUM=$(shuf -i 1000-9999 -n 1)
          BUILD_TAG="OpenWrt-ttyd-$(date +%Y%m%d)-${RANDOM_NUM}"
          echo "tag_name=$BUILD_TAG" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        run: |
          gh release create "${{ steps.tag_generator.outputs.tag_name }}" \
            --title "OpenWrt 24.10.4 TTYD HTTPS æž„å»º for RK3568 $(date +'%Y-%m-%d')" \
            --notes-file $SDK_DIR/upload/RELEASE_INFO.md \
            $SDK_DIR/upload/*.ipk \
            $SDK_DIR/upload/ttyd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ äº§ç‰©åˆ° GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-https-packages-24.10.4
          path: |
            $SDK_DIR/upload/*.ipk
            $SDK_DIR/upload/ttyd
          if-no-files-found: warn
