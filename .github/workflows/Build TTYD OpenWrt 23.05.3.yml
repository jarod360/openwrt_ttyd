name: ä¸º RK3568 æ„å»ºå¸¦ HTTPS (TLS) çš„ TTYDï¼Œä½¿ç”¨ OpenWrt 24.10.4

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿æ¥åˆ° Actions'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai
  # ä½¿ç”¨ OpenWrt 24.10.4 SDK for Rockchip ARMv8
  SDK_URL: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android || true
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

      - name: ä¸‹è½½å¹¶è§£å‹ OpenWrt 24.10.4 SDK
        run: |
          wget -q ${{ env.SDK_URL }}
          file_name=$(echo ${{ env.SDK_URL }} | awk -F/ '{print $NF}')
          mkdir -p sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            # ä½¿ç”¨ tar --zstd å¦‚æœå¯ç”¨ï¼Œå¦åˆ™ä½¿ç”¨ zstd -d
            if tar --version 2>/dev/null | grep -q zstd; then
              tar --zstd -x -f $file_name -C ./sdk --strip-components=1
            else
              # å¤‡ç”¨è§£å‹ï¼šå…ˆè§£å‹ zst åˆ°ä¸´æ—¶ .tarï¼Œç„¶åæå–
              zstd -d -c "$file_name" > /tmp/sdk.tar && tar -xf /tmp/sdk.tar -C ./sdk --strip-components=1
            fi
          else
            echo "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_name"
            exit 1
          fi
          echo "SDK_DIR=$PWD/sdk" >> $GITHUB_ENV

      - name: å¤åˆ¶è‡ªå®šä¹‰è½¯ä»¶åŒ…åˆ° SDK
        run: |
          # æ£€æŸ¥åŒ…ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "libwebsockets-full" ]; then
            cp -r libwebsockets-full $SDK_DIR/package/
            echo "âœ… libwebsockets-full åŒ…å·²å¤åˆ¶"
          else
            echo "âŒ libwebsockets-full ç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi

          if [ -d "ttyd" ]; then
            cp -r ttyd $SDK_DIR/package/
            echo "âœ… ttyd åŒ…å·²å¤åˆ¶"
          else
            echo "âŒ ttyd ç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi

          # å¤åˆ¶ luci-app-ttyd åŒ…
          if [ -d "luci-app-ttyd" ]; then
            cp -r luci-app-ttyd $SDK_DIR/package/
            echo "âœ… luci-app-ttyd åŒ…å·²å¤åˆ¶"
          else
            echo "âŒ luci-app-ttyd ç›®å½•æœªæ‰¾åˆ°"
            exit 1
          fi

      - name: SSH è¿æ¥åˆ° Actions (è°ƒè¯•)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: å½»åº•æ¸…ç†å®˜æ–¹ libwebsockets åŒ…
        run: |
          cd $SDK_DIR
          echo "=== å¼€å§‹å½»åº•æ¸…ç†å®˜æ–¹ libwebsockets åŒ… ==="

          # é¦–å…ˆæ›´æ–° feeds è·å–åŒ…åˆ—è¡¨
          ./scripts/feeds update -a

          # ä½¿ç”¨ feeds å‘½ä»¤å¸è½½å®˜æ–¹åŒ…ï¼ˆå®¹é”™ï¼‰
          ./scripts/feeds uninstall libwebsockets || true

          # å½»åº•åˆ é™¤æ‰€æœ‰å®˜æ–¹ libwebsockets ç›¸å…³æ–‡ä»¶
          echo "ç§»é™¤ feeds/packages/libs/libwebsockets..."
          rm -rf feeds/packages/libs/libwebsockets || true

          echo "ç§»é™¤ package/feeds/packages/libwebsockets..."
          rm -rf package/feeds/packages/libwebsockets || true

          echo "æœç´¢å¹¶ç§»é™¤å…¶ä»–ä½ç½®çš„ libwebsockets åŒ…..."
          find . -type d -name "libwebsockets" ! -path "*/libwebsockets-full/*" ! -path "*/dl/*" -exec echo "ç§»é™¤: {}" \; -exec rm -rf {} + || true

          # æ¸…ç†æ„å»ºç¼“å­˜
          echo "æ¸…ç†æ„å»ºç¼“å­˜..."
          rm -rf build_dir/target-*/libwebsockets-* || true
          rm -rf build_dir/target-*/libwebsockets || true
          rm -rf staging_dir/target-*/pkginfo/libwebsockets* || true

      - name: å®‰è£… feeds å¹¶éªŒè¯æ¸…ç†
        run: |
          cd $SDK_DIR
          echo "=== å®‰è£… feedsï¼ˆä¸åŒ…å«å®˜æ–¹ libwebsocketsï¼‰==="
          ./scripts/feeds install -a

          echo "=== éªŒè¯å®˜æ–¹ libwebsockets åŒ…æ˜¯å¦å·²å½»åº•åˆ é™¤ ==="
          if [ -d "feeds/packages/libs/libwebsockets" ]; then
            echo "âŒ é”™è¯¯ï¼šfeeds/packages/libs/libwebsockets ä»ç„¶å­˜åœ¨"
            exit 1
          fi

          if [ -d "package/feeds/packages/libwebsockets" ]; then
            echo "âŒ é”™è¯¯ï¼špackage/feeds/packages/libwebsockets ä»ç„¶å­˜åœ¨"
            exit 1
          fi

          echo "âœ… å®˜æ–¹ libwebsockets åŒ…å·²å½»åº•åˆ é™¤"
          echo "âœ… è‡ªå®šä¹‰ libwebsockets-full åŒ…çŠ¶æ€ï¼š"
          find package -name "*libwebsockets*" -type d || true

      - name: é…ç½® OpenWrt æ„å»º
        run: |
          cd $SDK_DIR
          echo "=== é…ç½®æ„å»ºç›®æ ‡ ==="
          # é…ç½®ä¸º RK3568 ç›®æ ‡
          cat > .config <<'EOF'
CONFIG_TARGET_rockchip=y
CONFIG_TARGET_rockchip_armv8=y
CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y
# é€‰æ‹© libuv å’Œè‡ªå®šä¹‰çš„ libwebsockets-full
CONFIG_PACKAGE_libuv=y
CONFIG_PACKAGE_libwebsockets-full=m
CONFIG_PACKAGE_ttyd=m
CONFIG_PACKAGE_luci-app-ttyd=m
# æ˜ç¡®ç¦ç”¨å…¶ä»– libwebsockets å˜ä½“
# CONFIG_PACKAGE_libwebsockets is not set
# CONFIG_PACKAGE_libwebsockets-openssl is not set
# CONFIG_PACKAGE_libwebsockets-mbedtls is not set
EOF

          echo "=== åº”ç”¨é»˜è®¤é…ç½® ==="
          make defconfig

          echo "=== æœ€ç»ˆé…ç½®æ£€æŸ¥ ==="
          echo "libuv å’Œ libwebsockets ç›¸å…³é…ç½®:"
          grep -E "CONFIG_PACKAGE_(libuv|libwebsockets|ttyd|luci-app-ttyd)" .config || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"

      - name: ä¸‹è½½è½¯ä»¶åŒ…æºç 
        run: |
          cd $SDK_DIR
          # é¦–å…ˆä¸‹è½½åŸºç¡€åŒ…å’Œè‡ªå®šä¹‰åŒ…
          echo "ä¸‹è½½ libuv æºç ..."
          make package/feeds/packages/libuv/download V=s || true

          if [ -d "package/libwebsockets-full" ]; then
            echo "ä¸‹è½½ libwebsockets-full æºç ..."
            make package/libwebsockets-full/download V=s || true
          fi

          make package/ttyd/download V=s || true
          make package/luci-app-ttyd/download V=s || true

          echo "æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶:"
          find dl -size -1024c -exec ls -l {} \; || true

      - name: å¯¹ luci æ„å»ºè„šæœ¬åšå®‰å…¨æ€§è¡¥ä¸ï¼ˆé¿å…æœªåŠ å¼•å·çš„ test å¯¼è‡´é”™è¯¯ï¼‰   # <<< CHANGED
        run: |
          cd $SDK_DIR
          # å¦‚æœå­˜åœ¨ feeds/luci/luci.mkï¼Œç»™å¸¸è§çš„ test/if æ¡ä»¶æ·»åŠ å¼•å·ï¼Œé˜²æ­¢åŒ…å«ç©ºæ ¼æ—¶å‡ºé”™
          LUCI_MK="feeds/luci/luci.mk"
          if [ -f "$LUCI_MK" ]; then
            # å¤‡ä»½åŸæ–‡ä»¶
            cp -a "$LUCI_MK" "$LUCI_MK.bak"
            # ç”¨æ¯”è¾ƒä¿å®ˆçš„æ›¿æ¢ï¼šå°†å¸¸è§å½¢æ€çš„ [ -f $VAR ] -> [ -f "$VAR" ] ç­‰
            /usr/bin/perl -0777 -pe 's/\[([[:space:]]*)(-f|-d|-e|-n|-z)([[:space:]]+)([^\]\n]+)\]/\[\1\2\3"\4"\]/g' -i "$LUCI_MK" || true
            echo "å·²å¯¹ $LUCI_MK è¿›è¡Œå®‰å…¨æ€§è¡¥ä¸ï¼ˆå¤‡ä»½: $LUCI_MK.bakï¼‰"
          else
            echo "$LUCI_MK ä¸å­˜åœ¨ï¼Œè·³è¿‡è¡¥ä¸"
          fi

      - name: ç¼–è¯‘ libuv
        id: compile_libuv
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ libuv..."
          make package/feeds/packages/libuv/clean V=s || true

          if make package/feeds/packages/libuv/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… libuv ç¼–è¯‘æˆåŠŸ"

            # éªŒè¯ç¼–è¯‘äº§ç‰©
            echo "=== æ£€æŸ¥ libuv ç¼–è¯‘äº§ç‰© ==="
            find bin -name "*libuv*" -type f | head -10 || echo "æœªæ‰¾åˆ° libuv äº§ç‰©"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ libuv ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ç¼–è¯‘ libwebsockets-full
        id: compile_libwebsockets
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ libwebsockets-full..."
          make package/libwebsockets-full/clean V=s || true

          if make package/libwebsockets-full/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… libwebsockets-full ç¼–è¯‘æˆåŠŸ"
            echo "=== æ£€æŸ¥ç¼–è¯‘äº§ç‰© ==="
            find bin -name "*libwebsockets*" -type f | head -10 || echo "æœªæ‰¾åˆ° libwebsockets äº§ç‰©"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ libwebsockets-full ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ç¼–è¯‘ ttyd
        id: compile_ttyd
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ ttyd..."
          make package/ttyd/clean V=s || true

          if make package/ttyd/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… ttyd ç¼–è¯‘æˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ ttyd ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ç¼–è¯‘ luci-app-ttydï¼ˆè®¾ç½® PKG_ARCH å¹¶å¢åŠ å®¹é”™ï¼‰    # <<< CHANGED
        id: compile_luci_app_ttyd
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ luci-app-ttyd..."
          make package/luci-app-ttyd/clean V=s || true

          # å¼ºåˆ¶åŒ…æ¶æ„ä¸º allï¼Œé˜²æ­¢æ‰“åŒ…æ—¶äº§ç”Ÿç©ºæ¶æ„å¯¼è‡´æ–‡ä»¶å/åˆ¤æ–­å¼‚å¸¸
          export PKG_ARCH=all
          echo "å·²è®¾ç½® PKG_ARCH=$PKG_ARCH"

          if make package/luci-app-ttyd/compile -j$(nproc) V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… luci-app-ttyd ç¼–è¯‘æˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ luci-app-ttyd ç¼–è¯‘å¤±è´¥"
            # è¾“å‡ºå¯èƒ½çš„æ‰“åŒ…äº§ç‰©ä»¥ä¾¿è°ƒè¯•
            echo "bin ç›®å½•å†…å®¹é¢„è§ˆï¼š"
            ls -la bin || true
            echo "build_dir ä¸­ luci-app-ttyd çš„å†…å®¹ï¼š"
            find build_dir -maxdepth 3 -type f -path "*luci-app-ttyd*" -print || true
            exit 1
          fi
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: æ”¶é›†æ„å»ºäº§ç‰©
        if: steps.compile_libuv.outputs.status == 'success' && steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.compile_luci_app_ttyd.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          mkdir -p upload

          # æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³çš„ IPK æ–‡ä»¶
          echo "=== æœç´¢ IPK æ–‡ä»¶ ==="
          find bin -type f -name "*.ipk" -print -exec cp -t upload/ {} + || true

          # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== æœç´¢äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          find build_dir -name "ttyd" -type f | while read file; do
            if file "$file" | grep -q "ELF"; then
              echo "æ‰¾åˆ° ELF äºŒè¿›åˆ¶æ–‡ä»¶: $file"
              cp "$file" upload/ttyd
              chmod +x upload/ttyd
              break
            fi
          done

          echo "ğŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -la upload/ || true

      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯
        id: release_info
        if: steps.compile_libuv.outputs.status == 'success' && steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.compile_luci_app_ttyd.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          BUILD_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')

          LIBUV_VERSION=$(find bin -name "*libuv*.ipk" -type f -print -quit | xargs -r basename | sed 's/[^0-9]*\([0-9.]*\).*/\1/' || echo "æœªçŸ¥ç‰ˆæœ¬")

          cat > upload/RELEASE_INFO.md << EOF
## ğŸŒ é€‚ç”¨äº RK3568 çš„ TTYD (HTTPS/TLS) æ„å»º - OpenWrt 24.10.4

### æ„å»ºä¿¡æ¯
- **æ„å»ºæ—¥æœŸ**: $BUILD_DATE
- **OpenWrt ç‰ˆæœ¬**: 24.10.4
- **ç›®æ ‡å¹³å°**: Rockchip ARMv8 (RK3568)
- **ä»£ç åº“**: ${{ github.repository }}
- **æäº¤**: ${{ github.sha }}
- **libuv ç‰ˆæœ¬**: $LIBUV_VERSION
- **libwebsockets**: è‡ªå®šä¹‰å®Œæ•´ç‰ˆï¼ˆå®Œå…¨æ›¿æ¢å®˜æ–¹ç‰ˆæœ¬ï¼‰

### åŒ…å«çš„è½¯ä»¶åŒ…
- **libuv**
- **ttyd**
- **libwebsockets-full**
- **luci-app-ttyd**
EOF

          echo '```' >> upload/RELEASE_INFO.md
          ls -la upload/ >> upload/RELEASE_INFO.md
          echo '```' >> upload/RELEASE_INFO.md

          echo "status=success" >> $GITHUB_OUTPUT

      - name: ç”ŸæˆåŒ…å«æ—¥æœŸå’Œéšæœºæ•°çš„å”¯ä¸€æ ‡ç­¾
        id: tag_generator
        if: steps.compile_libuv.outputs.status == 'success' && steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.compile_luci_app_ttyd.outputs.status == 'success' && steps.release_info.outputs.status == 'success'
        run: |
          # ç”Ÿæˆéšæœºå››ä½æ•°
          RANDOM_NUM=$(shuf -i 1000-9999 -n 1)
          # æ„å»ºæ ‡ç­¾ï¼šOpenWrt-ttyd-å¹´æœˆæ—¥-éšæœºå››ä½æ•°
          BUILD_TAG="OpenWrt-ttyd-$(date +%Y%m%d)-${RANDOM_NUM}"   # <<< CHANGED ä¿®æ­£å˜é‡å
          echo "ç”Ÿæˆçš„æ ‡ç­¾: $BUILD_TAG"
          echo "tag_name=$BUILD_TAG" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub å‘å¸ƒ
        if: steps.tag_generator.outputs.tag_name
        run: |
          echo "ä½¿ç”¨æ ‡ç­¾åˆ›å»ºå‘å¸ƒ: ${{ steps.tag_generator.outputs.tag_name }}"
          gh release create "${{ steps.tag_generator.outputs.tag_name }}" \
            --title "OpenWrt 24.10.4 TTYD HTTPS æ„å»º for RK3568 $(date +'%Y-%m-%d')" \
            --notes-file $SDK_DIR/upload/RELEASE_INFO.md \
            $SDK_DIR/upload/*.ipk \
            $SDK_DIR/upload/ttyd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ äº§ç‰©åˆ° GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-https-packages-24.10.4
          path: |
            $SDK_DIR/upload/*.ipk
            $SDK_DIR/upload/ttyd
          if-no-files-found: warn
