#
# Copyright (c) 2022-2025 SMALLPROGRAM <https://github.com/smallprogram>
# Description: Auto compile ttyd with openwrt sdk
#
name: "Auto compile ttyd with openwrt 22.03.5 sdk"

permissions:
  contents: write

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè¿æ¥ Actions'
        required: false
        default: 'false'
env:
  TZ: Asia/Shanghai
  repo: ${{ github.repository }}
  package_names: "libwebsockets-full ttyd luci-app-ttyd luci-app-diskman uhttpd"

jobs:
  job_auto_compile:
    runs-on: ubuntu-latest
    name: build packages (${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # ä½¿ç”¨ 22.03.5 ç¨³å®šç‰ˆ (ipk) å¹³å°
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/rockchip/armv8/openwrt-sdk-22.03.5-rockchip-armv8_gcc-11.2.0_musl.Linux-x86_64.tar.xz

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/mvebu/cortexa53/openwrt-sdk-22.03.5-mvebu-cortexa53_gcc-11.2.0_musl.Linux-x86_64.tar.xz

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/mvebu/cortexa72/openwrt-sdk-22.03.5-mvebu-cortexa72_gcc-11.2.0_musl.Linux-x86_64.tar.xz

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/sunxi/cortexa7/openwrt-sdk-22.03.5-sunxi-cortexa7_gcc-11.2.0_musl_eabi.Linux-x86_64.tar.xz

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/ath79/generic/openwrt-sdk-22.03.5-ath79-generic_gcc-11.2.0_musl.Linux-x86_64.tar.xz

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/releases/22.03.5/targets/ramips/rt288x/openwrt-sdk-22.03.5-ramips-rt288x_gcc-11.2.0_musl.Linux-x86_64.tar.xz

    steps:
      - name: åˆå§‹åŒ– ${{ matrix.platform }} ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          echo "å®‰è£…ç¼–è¯‘ä¾èµ–åŒ…"
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: ä¸‹è½½ ${{ matrix.platform }} SDK
        run: |
          wget ${{ matrix.url_sdk }}
          file_name=$(echo ${{matrix.url_sdk}} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_name"
            exit 1
          fi
          cd sdk

      - name: SSH è¿æ¥åˆ° Actions
        uses: mxschmitt/action-tmate@v3.13
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

      - name: é…ç½® ${{ matrix.platform }} feeds å¹¶åˆ é™¤ SDK ä¸­ä¸éœ€è¦çš„åŒ…
        run: |
          cd sdk
          
          echo "=== å¼€å§‹åˆ é™¤ SDK ä¸­ä¸éœ€è¦çš„åŒ… ==="
          
          # ä½¿ç”¨ find å‘½ä»¤æœç´¢ç›¸å…³åŒ…çš„ä½ç½®
          echo "æœç´¢ç›¸å…³åŒ…æ–‡ä»¶..."
          find . -type d -name "*ttyd*" -o -name "*libwebsockets*" -o -name "*luci-app-diskman*" -o -name "*luci-i18n*" -o -name "*uhttpd*" | head -40
          
          # åˆ é™¤æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰çš„åŒ…ï¼ŒåŒ…æ‹¬ uhttpd ç›¸å…³åŒ…
          echo "å¼€å§‹åˆ é™¤åŒ…..."
          for dir in \
            "package/feeds/packages/ttyd" \
            "package/feeds/packages/libwebsockets" \
            "package/feeds/packages/uhttpd" \
            "package/feeds/luci/luci-app-ttyd" \
            "package/feeds/luci/luci-app-diskman" \
            "package/feeds/base/ttyd" \
            "package/feeds/base/libwebsockets" \
            "package/feeds/base/uhttpd" \
            "package/feeds/base/luci-app-ttyd" \
            "package/feeds/base/luci-app-diskman" \
            "package/network/services/ttyd" \
            "package/network/services/libwebsockets" \
            "package/network/services/uhttpd" \
            "feeds/packages/utils/ttyd" \
            "feeds/packages/libs/libwebsockets" \
            "feeds/packages/net/uhttpd" \
            "feeds/luci/applications/luci-app-ttyd" \
            "feeds/luci/applications/luci-app-diskman" \
            "feeds/luci/collections/luci" \
            "feeds/base/ttyd" \
            "feeds/base/libwebsockets" \
            "feeds/base/uhttpd" \
            "feeds/base/luci-app-ttyd" \
            "feeds/base/luci-app-diskman"; do
            if [ -d "$dir" ]; then
              echo "åˆ é™¤ç›®å½•: $dir"
              rm -rf "$dir"
            fi
          done
          
          # å†æ¬¡æœç´¢ç¡®è®¤åˆ é™¤ç»“æœ
          echo "=== ç¡®è®¤åˆ é™¤ç»“æœ ==="
          echo "å‰©ä½™ç›¸å…³ç›®å½•:"
          find . -type d \( -name "*ttyd*" -o -name "*libwebsockets*" -o -name "*luci-app-diskman*" -o -name "*uhttpd*" \) | head -25
          
          # æ›´æ–° feeds åˆ° github æº
          sed -i \
              -e 's|git\.openwrt\.org/feed|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/project|github.com/openwrt|g' \
              -e 's|git\.openwrt\.org/openwrt|github.com/openwrt|g' \
              "feeds.conf.default"

          # æ·»åŠ æˆ‘ä»¬çš„ä»“åº“åˆ° feeds
          cat > feeds.tmp <<'EOF'
          src-git custom_packages https://github.com/${{ env.repo }}.git;${{ github.ref_name }}
          EOF
          cat feeds.conf.default >> feeds.tmp
          mv feeds.tmp feeds.conf.default

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # å†æ¬¡æ£€æŸ¥å¹¶åˆ é™¤å¯èƒ½é€šè¿‡ feeds é‡æ–°å®‰è£…çš„åŒ…
          echo "=== å†æ¬¡æ£€æŸ¥å¹¶åˆ é™¤ feeds å®‰è£…çš„åŒ… ==="
          for dir in \
            "package/feeds/packages/ttyd" \
            "package/feeds/packages/libwebsockets" \
            "package/feeds/packages/uhttpd" \
            "package/feeds/luci/luci-app-ttyd" \
            "package/feeds/luci/luci-app-diskman"; do
            if [ -d "$dir" ]; then
              echo "åˆ é™¤ feeds ç›®å½•: $dir"
              rm -rf "$dir"
            fi
          done

          # éªŒè¯æˆ‘ä»¬çš„åŒ…æ˜¯å¦å­˜åœ¨ï¼ˆåªéªŒè¯æˆ‘ä»¬æä¾›çš„åŒ…ï¼‰
          echo "=== éªŒè¯æˆ‘ä»¬çš„åŒ… ==="
          for pkg in libwebsockets-full ttyd luci-app-ttyd luci-app-diskman uhttpd; do
            if [ -d "feeds/custom_packages/package/$pkg" ]; then
              echo "âœ“ æ‰¾åˆ°æˆ‘ä»¬çš„ $pkg åŒ…"
            else
              echo "âœ— æœªæ‰¾åˆ°æˆ‘ä»¬çš„ $pkg åŒ…"
              exit 1
            fi
          done

          # éªŒè¯ SDK çš„ libuv æ˜¯å¦å­˜åœ¨
          echo "=== éªŒè¯ SDK çš„ libuv ==="
          if find . -name "libuv" -type d | grep -q .; then
            echo "âœ“ æ‰¾åˆ° SDK çš„ libuv åŒ…"
          else
            echo "âœ— æœªæ‰¾åˆ° SDK çš„ libuv åŒ…"
            exit 1
          fi

          # æŸ¥æ‰¾ OpenSSL åŒ…çš„å®é™…ä½ç½®
          echo "=== æŸ¥æ‰¾ OpenSSL åŒ…ä½ç½® ==="
          OPENSSL_PATH=$(find . -type d -name "openssl" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$OPENSSL_PATH" ]; then
            echo "âœ“ æ‰¾åˆ° OpenSSL åŒ…ä½ç½®: $OPENSSL_PATH"
          else
            echo "âœ— æœªæ‰¾åˆ° OpenSSL åŒ…"
            # åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„åŒ…ç›®å½•
            find . -type d -name "*ssl*" | head -10
            exit 1
          fi

          # æ›´æ–°å¿…è¦çš„ç»„ä»¶
          rm -rf temp_resp
          git clone -b master --single-branch https://github.com/openwrt/packages.git temp_resp
          echo "æ›´æ–° golang ç‰ˆæœ¬"
          rm -rf feeds/packages/lang/golang
          cp -r temp_resp/lang/golang feeds/packages/lang
          rm -rf temp_resp

          git clone -b main --single-branch https://github.com/openwrt/openwrt.git temp_resp
          cp -f temp_resp/scripts/patch-kernel.sh scripts/
          rm -rf temp_resp

          # é…ç½®ç¼–è¯‘é€‰é¡¹ - æ·»åŠ è¯­è¨€åŒ…æ”¯æŒå’Œ uhttpd æ¨¡å—åŠå…¶ä¾èµ–
          echo "CONFIG_ALL_NONSHARED=n" > .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          # åŸºç¡€ä¾èµ–
          echo "CONFIG_PACKAGE_libuv=m" >> .config  # ä½¿ç”¨ SDK çš„ libuv
          # uhttpd ä¾èµ–é“¾
          echo "CONFIG_PACKAGE_libubox=m" >> .config
          echo "CONFIG_PACKAGE_libjson-script=m" >> .config
          echo "CONFIG_PACKAGE_libubus=m" >> .config
          echo "CONFIG_PACKAGE_libblobmsg-json=m" >> .config
          # ä¸»è¦åŒ…
          echo "CONFIG_PACKAGE_libwebsockets-full=m" >> .config
          echo "CONFIG_PACKAGE_ttyd=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman=m" >> .config
          # æ·»åŠ ä¸­æ–‡è¯­è¨€åŒ…æ”¯æŒ
          echo "CONFIG_PACKAGE_luci-i18n-ttyd-zh-cn=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=m" >> .config
          # æ·»åŠ  uhttpd åŠå…¶æ¨¡å—æ”¯æŒ
          echo "CONFIG_PACKAGE_uhttpd=m" >> .config
          echo "CONFIG_PACKAGE_uhttpd-mod-ubus=m" >> .config
          echo "CONFIG_PACKAGE_uhttpd-mod-lua=m" >> .config
          echo "CONFIG_PACKAGE_uhttpd-mod-ucode=m" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

          make defconfig

      - name: ${{ matrix.platform }} ç¼–è¯‘æ‰€æœ‰åŒ…
        id: compile
        run: |
          cd sdk
          echo "=== å¼€å§‹ç¼–è¯‘æ‰€æœ‰åŒ… ==="
          
          # éªŒè¯å½“å‰ç¼–è¯‘çš„æ˜¯æˆ‘ä»¬çš„åŒ…
          echo "=== éªŒè¯ç¼–è¯‘æº ==="
          for pkg in libwebsockets-full ttyd luci-app-ttyd luci-app-diskman uhttpd; do
            echo "$pkg è·¯å¾„:"
            find . -path "*/$pkg/Makefile" | grep -v "feeds/custom_packages" || echo "âœ“ åªæœ‰æˆ‘ä»¬çš„ $pkg"
          done
          
          # æŒ‰ä¾èµ–é¡ºåºç¼–è¯‘æ‰€æœ‰åŒ…ï¼ŒåŒ…æ‹¬è¯­è¨€åŒ…
          # é¦–å…ˆæŸ¥æ‰¾å¹¶ç¼–è¯‘åŸºç¡€ä¾èµ–åŒ…
          echo "----------- æŸ¥æ‰¾å¹¶ç¼–è¯‘åŸºç¡€ä¾èµ–åŒ… ---------------"
          
          # æŸ¥æ‰¾ json-c çš„å®é™…è·¯å¾„
          echo "æŸ¥æ‰¾ json-c åŒ…..."
          JSONC_PATH=$(find . -type d -name "json-c" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$JSONC_PATH" ]; then
            echo "æ‰¾åˆ° json-c è·¯å¾„: $JSONC_PATH"
            JSONC_REL_PATH=${JSONC_PATH#./}
            echo "ç¼–è¯‘ json-c: $JSONC_REL_PATH"
            make $JSONC_REL_PATH/compile -j$(nproc) V=sc && echo "âœ“ json-c ç¼–è¯‘å®Œæˆ" || echo "âš  json-c ç¼–è¯‘å¤±è´¥ï¼Œå¯èƒ½å·²è¢«å…¶ä»–åŒ…ä¾èµ–ç¼–è¯‘"
          else
            echo "âš  æœªæ‰¾åˆ° json-c åŒ…ï¼Œè·³è¿‡ç¼–è¯‘"
          fi
          echo ""
          
          # ç„¶åç¼–è¯‘ libuvï¼ˆæ¥è‡ª SDKï¼‰
          echo "----------- å¼€å§‹ç¼–è¯‘ libuv (æ¥è‡ª SDK) ---------------"
          make package/feeds/packages/libuv/compile -j$(nproc) V=sc
          echo "âœ“ libuv ç¼–è¯‘å®Œæˆ"
          echo ""
          
          # ç¼–è¯‘ libubox ä¾èµ–é“¾
          echo "----------- æŸ¥æ‰¾å¹¶ç¼–è¯‘ libubox (uhttpd ä¾èµ–é“¾) ---------------"
          LIBUBOX_PATH=$(find . -type d -name "libubox" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$LIBUBOX_PATH" ]; then
            echo "æ‰¾åˆ° libubox è·¯å¾„: $LIBUBOX_PATH"
            LIBUBOX_REL_PATH=${LIBUBOX_PATH#./}
            echo "ç¼–è¯‘ libubox: $LIBUBOX_REL_PATH"
            make $LIBUBOX_REL_PATH/compile -j$(nproc) V=sc && echo "âœ“ libubox ç¼–è¯‘å®Œæˆ" || echo "âš  libubox ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
          else
            echo "âš  æœªæ‰¾åˆ° libubox åŒ…ï¼Œè·³è¿‡ç¼–è¯‘"
          fi
          echo ""
          
          echo "----------- æŸ¥æ‰¾å¹¶ç¼–è¯‘ libjson-script (uhttpd ä¾èµ–é“¾) ---------------"
          LIBJSON_SCRIPT_PATH=$(find . -type d -name "libjson-script" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$LIBJSON_SCRIPT_PATH" ]; then
            echo "æ‰¾åˆ° libjson-script è·¯å¾„: $LIBJSON_SCRIPT_PATH"
            LIBJSON_SCRIPT_REL_PATH=${LIBJSON_SCRIPT_PATH#./}
            echo "ç¼–è¯‘ libjson-script: $LIBJSON_SCRIPT_REL_PATH"
            make $LIBJSON_SCRIPT_REL_PATH/compile -j$(nproc) V=sc && echo "âœ“ libjson-script ç¼–è¯‘å®Œæˆ" || echo "âš  libjson-script ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
          else
            echo "âš  æœªæ‰¾åˆ° libjson-script åŒ…ï¼Œè·³è¿‡ç¼–è¯‘"
          fi
          echo ""
          
          # ç¼–è¯‘ uhttpd çš„å…¶ä»–ä¾èµ–
          echo "----------- æŸ¥æ‰¾å¹¶ç¼–è¯‘ libubus (uhttpd ä¾èµ–) ---------------"
          LIBUBUS_PATH=$(find . -type d -name "libubus" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$LIBUBUS_PATH" ]; then
            echo "æ‰¾åˆ° libubus è·¯å¾„: $LIBUBUS_PATH"
            LIBUBUS_REL_PATH=${LIBUBUS_PATH#./}
            echo "ç¼–è¯‘ libubus: $LIBUBUS_REL_PATH"
            make $LIBUBUS_REL_PATH/compile -j$(nproc) V=sc && echo "âœ“ libubus ç¼–è¯‘å®Œæˆ" || echo "âš  libubus ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
          else
            echo "âš  æœªæ‰¾åˆ° libubus åŒ…ï¼Œè·³è¿‡ç¼–è¯‘"
          fi
          echo ""
          
          echo "----------- æŸ¥æ‰¾å¹¶ç¼–è¯‘ libblobmsg-json (uhttpd ä¾èµ–) ---------------"
          LIBBLOBMSG_JSON_PATH=$(find . -type d -name "libblobmsg-json" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$LIBBLOBMSG_JSON_PATH" ]; then
            echo "æ‰¾åˆ° libblobmsg-json è·¯å¾„: $LIBBLOBMSG_JSON_PATH"
            LIBBLOBMSG_JSON_REL_PATH=${LIBBLOBMSG_JSON_PATH#./}
            echo "ç¼–è¯‘ libblobmsg-json: $LIBBLOBMSG_JSON_REL_PATH"
            make $LIBBLOBMSG_JSON_REL_PATH/compile -j$(nproc) V=sc && echo "âœ“ libblobmsg-json ç¼–è¯‘å®Œæˆ" || echo "âš  libblobmsg-json ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
          else
            echo "âš  æœªæ‰¾åˆ° libblobmsg-json åŒ…ï¼Œè·³è¿‡ç¼–è¯‘"
          fi
          echo ""
          
          # æŸ¥æ‰¾å¹¶ç¼–è¯‘ OpenSSLï¼ˆæ¥è‡ª SDKï¼‰
          echo "----------- æŸ¥æ‰¾å¹¶ç¼–è¯‘ OpenSSL (æ¥è‡ª SDK) ---------------"
          OPENSSL_PATH=$(find . -type d -name "openssl" | grep -E "(package/|feeds/)" | head -1)
          if [ -n "$OPENSSL_PATH" ]; then
            echo "æ‰¾åˆ° OpenSSL è·¯å¾„: $OPENSSL_PATH"
            OPENSSL_REL_PATH=${OPENSSL_PATH#./}
            echo "ç¼–è¯‘ OpenSSL: $OPENSSL_REL_PATH"
            make $OPENSSL_REL_PATH/compile -j$(nproc) V=sc && echo "âœ“ OpenSSL ç¼–è¯‘å®Œæˆ" || echo "âš  OpenSSL ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
          else
            echo "âš  æœªæ‰¾åˆ° OpenSSL åŒ…ï¼Œè·³è¿‡ç¼–è¯‘"
          fi
          echo ""
          
          # ç„¶åç¼–è¯‘æˆ‘ä»¬è‡ªå®šä¹‰çš„åŒ…
          for pkg in libwebsockets-full ttyd uhttpd luci-app-ttyd luci-app-diskman; do
            if [ -d "feeds/custom_packages/package/$pkg" ]; then
                echo "----------- å¼€å§‹ç¼–è¯‘ $pkg ---------------"
                make package/feeds/custom_packages/$pkg/compile -j$(nproc) V=sc
                echo "âœ“ $pkg ç¼–è¯‘å®Œæˆ"
                echo ""
            else
                echo "âœ— é”™è¯¯: åœ¨ custom_packages ä¸­æœªæ‰¾åˆ° $pkg"
                exit 1
            fi
          done

          # ç¼–è¯‘ uhttpd æ¨¡å—ï¼ˆè¿™äº›æ¨¡å—åº”è¯¥ç”± uhttpd åŒ…è‡ªåŠ¨ç”Ÿæˆï¼‰
          echo "----------- å¼€å§‹ç¼–è¯‘ uhttpd æ¨¡å— ---------------"
          for module in uhttpd-mod-ubus uhttpd-mod-lua uhttpd-mod-ucode; do
            echo "ç¼–è¯‘ $module..."
            make package/feeds/custom_packages/uhttpd/$module/compile -j$(nproc) V=sc && echo "âœ“ $module ç¼–è¯‘å®Œæˆ" || echo "âš  $module ç¼–è¯‘å¯èƒ½å·²åŒ…å«åœ¨ uhttpd ä¸»åŒ…ä¸­"
          done
          echo ""

          # æœ€åç¼–è¯‘è¯­è¨€åŒ…
          echo "----------- å¼€å§‹ç¼–è¯‘è¯­è¨€åŒ… ---------------"
          for lang_pkg in luci-i18n-ttyd-zh-cn luci-i18n-diskman-zh-cn; do
            echo "ç¼–è¯‘ $lang_pkg..."
            make package/feeds/luci/$lang_pkg/compile -j$(nproc) V=sc && echo "âœ“ $lang_pkg ç¼–è¯‘å®Œæˆ" || echo "âš  $lang_pkg ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
          done
          echo ""

          echo "=== æ‰€æœ‰åŒ…ç¼–è¯‘å®Œæˆ ==="
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ•´ç† ${{ matrix.platform }} æ–‡ä»¶
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk

          mkdir -p tmp_upload
          shopt -s nullglob 
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶æ‰€æœ‰ç¼–è¯‘çš„åŒ…ï¼ŒåŒ…æ‹¬è¯­è¨€åŒ…ã€libuvã€json-c å’Œ uhttpd ç›¸å…³ä¾èµ–åŒ…
          for src_dir in bin/packages/*/{packages,custom_packages,luci,base}; do
              [[ -d "$src_dir" ]] || continue

              echo "æ‰«æç›®å½•: $src_dir"

              # æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³åŒ…ï¼ŒåŒ…æ‹¬ä¾èµ–åŒ…ã€è¯­è¨€åŒ…ã€libuv å’Œ uhttpd ç›¸å…³åŒ…
              for prefix in json-c libuv libubox libjson-script libubus libblobmsg-json libwebsockets ttyd luci-app-ttyd luci-app-diskman luci-i18n uhttpd; do
                  for file in "$src_dir"/"$prefix"*; do
                      [[ -f "$file" ]] || continue

                      filename=$(basename "$file")
                      # æ’é™¤ä¸éœ€è¦çš„ luci-i18n-base-zh-cn åŒ…
                      if [[ "$filename" == *"luci-i18n-base-zh-cn"* ]]; then
                          echo "  è·³è¿‡æ–‡ä»¶: $filename (ä¸éœ€è¦çš„åŒ…)"
                          continue
                      fi
                      # æ’é™¤é‡å¤çš„ libubus-lua åŒ…ï¼ˆå¦‚æœæœ‰ï¼‰
                      if [[ "$filename" == *"libubus-lua"* ]]; then
                          echo "  è·³è¿‡æ–‡ä»¶: $filename (ä¸éœ€è¦çš„åŒ…)"
                          continue
                      fi
                      echo "  æ‰¾åˆ°æ–‡ä»¶: $filename"
                      cp -r "$file" "tmp_upload/"
                  done
              done
          done

          # åˆ›å»ºä¸Šä¼ ç›®å½•å¹¶æ‰“åŒ…æ–‡ä»¶
          mkdir -p upload
          if [ "$(ls -A tmp_upload/)" ]; then
              zip -jr upload/packages_${{ matrix.platform }}.zip tmp_upload/*
              echo "æ–‡ä»¶æ‰“åŒ…æˆåŠŸ"
              echo "æ‰“åŒ…çš„æ–‡ä»¶åˆ—è¡¨:"
              ls -la tmp_upload/
              echo "=== æ–‡ä»¶è¯¦æƒ… ==="
              for file in tmp_upload/*; do
                echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
              done
          else
              echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶è¿›è¡Œæ‰“åŒ…"
              find bin/packages -name "*json-c*" -o -name "*libuv*" -o -name "*libubox*" -o -name "*libjson-script*" -o -name "*libubus*" -o -name "*libblobmsg-json*" -o -name "*ttyd*" -o -name "*libwebsockets*" -o -name "*luci-app-diskman*" -o -name "*luci-i18n*" -o -name "*uhttpd*" | head -40
              exit 1
          fi

          echo "FIRMWARE=$PWD/upload" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd sdk
          # å°†ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ç›´æ¥æ”¾åœ¨ upload ç›®å½•ä¸­
          echo "## ğŸš€ OpenWrtè½¯ä»¶åŒ…ç¼–è¯‘æŠ¥å‘Š" > upload/release_${{ matrix.platform }}.txt
          echo "### ç¼–è¯‘ä¿¡æ¯" >> upload/release_${{ matrix.platform }}.txt
          echo "**å¹³å°**: ${{ matrix.platform }}" >> upload/release_${{ matrix.platform }}.txt
          echo "**ç¼–è¯‘æ—¥æœŸ**: $(date)" >> upload/release_${{ matrix.platform }}.txt

          echo "### ç¼–è¯‘çš„è½¯ä»¶åŒ…" >> upload/release_${{ matrix.platform }}.txt
          echo "**åŒ…å**|**ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "-|-" >> upload/release_${{ matrix.platform }}.txt

          # ä» Makefiles æå–ç‰ˆæœ¬ä¿¡æ¯ - æˆ‘ä»¬è‡ªå®šä¹‰çš„åŒ…
          for pkg in libwebsockets-full ttyd luci-app-ttyd luci-app-diskman uhttpd; do
            if [ -f "feeds/custom_packages/package/$pkg/Makefile" ]; then
                version=$(awk -F ':=' '/PKG_VERSION:=/{version=$2} /PKG_RELEASE:=/{release=$2} END{print version"-"release}' feeds/custom_packages/package/$pkg/Makefile | tr -d ' ')
                echo "**$pkg**|**$version**" >> upload/release_${{ matrix.platform }}.txt
            fi
          done

          # æ·»åŠ  SDK åŒ…ä¿¡æ¯å’Œ uhttpd æ¨¡å—åŠä¾èµ–åŒ…
          echo "**json-c**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**libuv**|**SDK ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**libubox**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**libjson-script**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**libubus**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**libblobmsg-json**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**uhttpd-mod-ubus**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**uhttpd-mod-lua**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**uhttpd-mod-ucode**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**luci-i18n-ttyd-zh-cn**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt
          echo "**luci-i18n-diskman-zh-cn**|**ç¼–è¯‘ç‰ˆæœ¬**" >> upload/release_${{ matrix.platform }}.txt

          echo "### æ–‡ä»¶åˆ—è¡¨" >> upload/release_${{ matrix.platform }}.txt
          echo "\`\`\`" >> upload/release_${{ matrix.platform }}.txt
          ls -la tmp_upload/ >> upload/release_${{ matrix.platform }}.txt
          echo "\`\`\`" >> upload/release_${{ matrix.platform }}.txt

          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ åˆ¶å“åˆ° Artifact
        uses: actions/upload-artifact@v4
        if: steps.info.outputs.status == 'success'
        with:
          name: packages_${{ matrix.platform }}
          path: |
            ${{ env.FIRMWARE }}/packages_${{ matrix.platform }}.zip
            ${{ env.FIRMWARE }}/release_${{ matrix.platform }}.txt
          retention-days: 30

  create_release:
    runs-on: ubuntu-latest
    name: åˆ›å»ºç»Ÿä¸€ Release
    needs: job_auto_compile
    if: always() && needs.job_auto_compile.result == 'success'
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰å¹³å°çš„åˆ¶å“
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: ç”Ÿæˆéšæœºæ ‡ç­¾åå’Œå‘å¸ƒæ—¥æœŸ
        id: date_info
        run: |
          # ç”Ÿæˆ4ä½éšæœºæ•°
          RANDOM_SUFFIX=$(shuf -i 1000-9999 -n 1)
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "éšæœºåç¼€: $RANDOM_SUFFIX"
          echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
          echo "tag_name=openwrt-packages-$(date +%Y%m%d)-${RANDOM_SUFFIX}" >> $GITHUB_OUTPUT
          echo "release_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
      - name: åˆ›å»ºç»Ÿä¸€çš„ Release ä¿¡æ¯
        run: |
          echo "# ğŸ‰ OpenWrt 22.03.5å¹³å° openssl 1.1.xç‰ˆæœ¬å¤šå¹³å°è½¯ä»¶åŒ…ç¼–è¯‘å®Œæˆ" > release_body.md
          echo "" >> release_body.md
          echo "## ğŸ“¦ åŒ…å«çš„è½¯ä»¶åŒ…" >> release_body.md
          echo "- **json-c**: JSON è§£æåº“ (ä¾èµ–åŒ…)" >> release_body.md
          echo "- **libuv**: è·¨å¹³å°å¼‚æ­¥ I/O åº“ (æ¥è‡ª SDK)" >> release_body.md
          echo "- **libubox**: OpenWrt åŸºç¡€åº“ (uhttpd ä¾èµ–é“¾)" >> release_body.md
          echo "- **libjson-script**: JSON è„šæœ¬è§£æåº“ (uhttpd ä¾èµ–é“¾)" >> release_body.md
          echo "- **libubus**: OpenWrt RPC é€šä¿¡åº“ (uhttpd ä¾èµ–)" >> release_body.md
          echo "- **libblobmsg-json**: libubus çš„ JSON æ•°æ®å¤„ç†åº“ (uhttpd ä¾èµ–)" >> release_body.md
          echo "- **libwebsockets-full**: å®Œæ•´çš„ WebSocket åº“" >> release_body.md
          echo "- **ttyd**: é€šè¿‡ Web å…±äº«ç»ˆç«¯" >> release_body.md
          echo "- **luci-app-ttyd**: ttyd çš„ LuCI ç•Œé¢" >> release_body.md
          echo "- **luci-app-diskman**: ç£ç›˜ç®¡ç† LuCI åº”ç”¨" >> release_body.md
          echo "- **uhttpd**: è‡ªå®šä¹‰ uHTTPd Web æœåŠ¡å™¨" >> release_body.md
          echo "- **uhttpd-mod-ubus**: uHTTPd UBus æ”¯æŒæ¨¡å—" >> release_body.md
          echo "- **uhttpd-mod-lua**: uHTTPd Lua æ”¯æŒæ¨¡å—" >> release_body.md
          echo "- **uhttpd-mod-ucode**: uHTTPd uCode æ”¯æŒæ¨¡å—" >> release_body.md
          echo "- **luci-i18n-ttyd-zh-cn**: ttyd ä¸­æ–‡è¯­è¨€åŒ…" >> release_body.md
          echo "- **luci-i18n-diskman-zh-cn**: diskman ä¸­æ–‡è¯­è¨€åŒ…" >> release_body.md
          echo "" >> release_body.md
          echo "## ğŸ–¥ï¸ æ”¯æŒçš„å¹³å°" >> release_body.md
          
          # æ”¶é›†æ‰€æœ‰å¹³å°çš„ä¿¡æ¯
          for platform_dir in artifacts/*/; do
            platform=$(basename $platform_dir | sed 's/packages_//')
            if [ -f "$platform_dir/release_$platform.txt" ]; then
              echo "### $platform" >> release_body.md
              # æå–ç¼–è¯‘çš„è½¯ä»¶åŒ…ä¿¡æ¯
              echo "\`\`\`" >> release_body.md
              cat "$platform_dir/release_$platform.txt" | sed -n '/### ç¼–è¯‘çš„è½¯ä»¶åŒ…/,/### æ–‡ä»¶åˆ—è¡¨/p' | head -n -1 >> release_body.md
              echo "\`\`\`" >> release_body.md
              echo "" >> release_body.md
            fi
          done
          
          echo "## ğŸ“‹ æ–‡ä»¶åˆ—è¡¨" >> release_body.md
          echo "æ¯ä¸ªå¹³å°ä¸€ä¸ªå‹ç¼©åŒ…ï¼ŒåŒ…å«è¯¥å¹³å°çš„æ‰€æœ‰ ipk æ–‡ä»¶ã€‚" >> release_body.md
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "\`\`\`" >> release_body.md
          find artifacts -name "*.zip" -exec basename {} \; | sort >> release_body.md
          echo "\`\`\`" >> release_body.md
          
          echo "" >> release_body.md
          echo "## ğŸš€ ä½¿ç”¨æ–¹æ³•" >> release_body.md
          echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…" >> release_body.md
          echo "2. è§£å‹åé€šè¿‡ opkg å®‰è£…æ‰€éœ€çš„ ipk æ–‡ä»¶" >> release_body.md
          echo "3. æ³¨æ„ä¾èµ–å…³ç³»ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®‰è£…ï¼š" >> release_body.md
          echo "   - json-c" >> release_body.md
          echo "   - libuv" >> release_body.md
          echo "   - libubox" >> release_body.md
          echo "   - libjson-script" >> release_body.md
          echo "   - libubus" >> release_body.md
          echo "   - libblobmsg-json" >> release_body.md
          echo "   - libwebsockets-full" >> release_body.md
          echo "   - ttyd" >> release_body.md
          echo "   - luci-app-ttyd" >> release_body.md
          echo "   - luci-i18n-ttyd-zh-cn" >> release_body.md
          echo "   - luci-app-diskman" >> release_body.md
          echo "   - luci-i18n-diskman-zh-cn" >> release_body.md
          echo "   - uhttpd" >> release_body.md
          echo "   - uhttpd-mod-ubus" >> release_body.md
          echo "   - uhttpd-mod-lua" >> release_body.md
          echo "   - uhttpd-mod-ucode" >> release_body.md
          echo "" >> release_body.md
          echo "## ğŸ”— ä¾èµ–å…³ç³»" >> release_body.md
          echo "- **uhttpd** ä¾èµ– **libubus** å’Œ **libblobmsg-json**" >> release_body.md
          echo "- **libubus** ä¾èµ– **json-c**ã€**libubox** å’Œ **libjson-script**" >> release_body.md
          echo "- **libblobmsg-json** ä¾èµ– **libubox** å’Œ **json-c**" >> release_body.md
          echo "- **ttyd** ä¾èµ– **libwebsockets-full** å’Œ **libuv**" >> release_body.md

      - name: å‡†å¤‡ Release æ–‡ä»¶
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾æ‰€æœ‰è¦å‘å¸ƒçš„æ–‡ä»¶
          mkdir -p release_files
          
          # å¤åˆ¶æ‰€æœ‰ zip æ–‡ä»¶
          find artifacts -name "*.zip" -exec cp {} release_files/ \;
          
          # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
          echo "=== å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ ==="
          ls -la release_files/

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.date_info.outputs.tag_name }}
          name: "OpenWrt Packages - ${{ steps.date_info.outputs.release_date }}"
          body_path: release_body.md
          files: release_files/*.zip
          draft: false
          prerelease: false
