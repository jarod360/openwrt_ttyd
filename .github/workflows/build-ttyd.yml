name: Build TTYD with HTTPS (TLS) for RK3568

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: read

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04  # ‰ΩøÁî® Ubuntu 22.04 LTS
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout LEDE source
        run: |
          git clone https://github.com/coolsnowwolf/lede.git lede-source
          cd lede-source
          echo "LEDE_DIR=$PWD" >> $GITHUB_ENV

      - name: Install build dependencies
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

      - name: Copy custom packages to LEDE
        run: |
          # Ê£ÄÊü•ÂåÖÁõÆÂΩïÊòØÂê¶Â≠òÂú®
          if [ -d "libwebsockets-full" ]; then
            cp -r libwebsockets-full $LEDE_DIR/package/
            echo "‚úÖ libwebsockets-full package copied"
          else
            echo "‚ùå libwebsockets-full directory not found"
            exit 1
          fi
          
          if [ -d "ttyd" ]; then
            cp -r ttyd $LEDE_DIR/package/
            echo "‚úÖ ttyd package copied"
          else
            echo "‚ùå ttyd directory not found"
            exit 1
          fi

      - name: SSH connection to Actions (debug)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: Setup LEDE feeds and configuration
        run: |
          cd $LEDE_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # ÈÖçÁΩÆ‰∏∫ RK3568 ÁõÆÊ†á
          echo "CONFIG_TARGET_rockchip=y" > .config
          echo "CONFIG_TARGET_rockchip_armv8=y" >> .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y" >> .config
          echo "CONFIG_PACKAGE_libwebsockets-full=m" >> .config
          echo "CONFIG_PACKAGE_ttyd=m" >> .config
          
          make defconfig

      - name: Download package sources
        run: |
          cd $LEDE_DIR
          make package/libwebsockets-full/download V=s
          make package/ttyd/download V=s
          find dl -size -1024c -exec ls -l {} \; || true

      - name: Compile libwebsockets-full
        id: compile_libwebsockets
        run: |
          cd $LEDE_DIR
          echo "üöÄ Starting libwebsockets-full compilation..."
          make package/libwebsockets-full/clean V=s
          make package/libwebsockets-full/compile -j$(nproc) V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Compile ttyd
        id: compile_ttyd
        run: |
          cd $LEDE_DIR
          echo "üöÄ Starting ttyd compilation..."
          make package/ttyd/clean V=s
          make package/ttyd/compile -j$(nproc) V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Collect build artifacts
        if: steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success'
        run: |
          cd $LEDE_DIR
          mkdir -p upload
          
          # Êü•ÊâæÊâÄÊúâÁõ∏ÂÖ≥ÁöÑ IPK Êñá‰ª∂
          echo "=== Searching for IPK files ==="
          find bin -name "*ttyd*.ipk" -type f | while read file; do
            echo "Found ttyd IPK: $file"
            cp "$file" upload/
          done
          
          find bin -name "*libwebsockets*.ipk" -type f | while read file; do
            echo "Found libwebsockets IPK: $file"
            cp "$file" upload/
          done
          
          # Êü•Êâæ‰∫åËøõÂà∂Êñá‰ª∂
          echo "=== Searching for binary files ==="
          find build_dir -name "ttyd" -type f | while read file; do
            if file "$file" | grep -q "ELF"; then
              echo "Found ELF binary: $file"
              cp "$file" upload/ttyd
              chmod +x upload/ttyd
              break
            fi
          done
          
          echo "üìÅ Upload directory contents:"
          ls -la upload/

      - name: Generate release info
        id: release_info
        if: steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success'
        run: |
          cd $LEDE_DIR
          cat > upload/RELEASE_INFO.md << 'EOF'
          ## üåê TTYD (HTTPS/TLS) Build for RK3568
          
          ### Build Information
          - **Build Date**: $(date)
          - **Source**: coolsnowwolf/lede
          - **Target**: Rockchip ARMv8 (RK3568)
          - **Repository**: ${{ github.repository }}
          - **Commit**: ${{ github.sha }}
          
          ### Packages Included
          - **ttyd** - Share your terminal over the web with TLS/SSL support[citation:2][citation:3]
          - **libwebsockets-full** - Full WebSocket library with OpenSSL support
          
          ### Installation Instructions
          1. Upload the IPK files to your RK3568 OpenWrt device
          2. Install packages:
          ```bash
          opkg install libwebsockets-full_*.ipk
          opkg install ttyd_*.ipk
          ```
          
          3. Generate SSL certificates and start HTTPS server[citation:7]:
          ```bash
          # Create SSL directory
          mkdir -p /etc/ssl
          
          # Generate self-signed certificate
          openssl req -x509 -newkey rsa:2048 \
            -keyout /etc/ssl/ttyd.key \
            -out /etc/ssl/ttyd.crt \
            -days 365 -nodes \
            -subj '/CN=localhost'
            
          # Start ttyd with SSL
          ttyd --ssl --ssl-cert /etc/ssl/ttyd.crt --ssl-key /etc/ssl/ttyd.key bash
          ```
          
          4. Access via browser: `https://your-device-ip:7681`
          
          ### ttyd SSL Options[citation:5][citation:8]
          - `--ssl`: Enable SSL
          - `--ssl-cert`: SSL certificate file path  
          - `--ssl-key`: SSL key file path
          - `--ssl-ca`: SSL CA file path for client certificate verification
          
          ### File List
          EOF
          
          echo "\`\`\`" >> upload/RELEASE_INFO.md
          ls -la upload/ >> upload/RELEASE_INFO.md
          echo "\`\`\`" >> upload/RELEASE_INFO.md
          
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.compile_libwebsockets.outputs.status == 'success' && steps.compile_ttyd.outputs.status == 'success' && steps.release_info.outputs.status == 'success'
        run: |
          BUILD_TAG="build-$(date +%Y%m%d-%H%M%S)"
          echo "Creating release with tag: $BUILD_TAG"
          gh release create "$BUILD_TAG" \
            --title "TTYD HTTPS Build for RK3568 $(date +'%Y-%m-%d %H:%M')" \
            --notes-file $LEDE_DIR/upload/RELEASE_INFO.md \
            $LEDE_DIR/upload/*.ipk \
            $LEDE_DIR/upload/ttyd \
            --prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ttyd-https-packages
          path: |
            $LEDE_DIR/upload/*.ipk
            $LEDE_DIR/upload/ttyd
          if-no-files-found: warn

      - name: Debug build directory structure
        if: always()
        run: |
          cd $LEDE_DIR
          echo "üîç Debugging build directory structure..."
          echo "=== All IPK files ==="
          find bin -name "*.ipk" -type f | head -20
